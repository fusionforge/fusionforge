#!/bin/bash
# Tricks to install unavailable packages - used by install.sh and install-src.sh
#
# Copyright (C) 2011  Roland Mas
# Copyright (C) 2011  Olivier Berger - Institut Telecom
# Copyright (C) 2014  Inria (Sylvain Beucler)
#
# This file is part of FusionForge. FusionForge is free software;
# you can redistribute it and/or modify it under the terms of the
# GNU General Public License as published by the Free Software
# Foundation; either version 2 of the Licence, or (at your option)
# any later version.
#
# FusionForge is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License along
# with FusionForge; if not, write to the Free Software Foundation, Inc.,
# 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.


function backports_deb {
    if grep -q ^7 /etc/debian_version; then
	# Install OpenSSH 6.6 to get AuthorizedKeysCommand support
	if [ ! -f /etc/apt/sources.list.d/backports.list ]; then
	    echo 'deb http://http.debian.net/debian wheezy-backports main' \
		> /etc/apt/sources.list.d/backports.list
	    apt-get update
	fi
	if dpkg-query -s openssh-server | grep -q 'Version: 1:6.0'; then
	    apt-get -y install openssh-server -t wheezy-backports
	fi

	# fusionforge-plugin-scmbzr depends on loggerhead (>=
	# 1.19~bzr477~), but wheezy only has 1.19~bzr461-1, so we need
	# to manually "Backport" a more recent dependency
	if ! dpkg-query -s loggerhead >/dev/null 2>&1 ; then
	    # install loggerhead with its dependencies
	    # we need gdebi to make sure dependencies are installed too (simple dpkg -i won't)
	    apt-get -y install gdebi-core wget
	    wget -c http://snapshot.debian.org/archive/debian/20121107T152130Z/pool/main/l/loggerhead/loggerhead_1.19%7Ebzr477-1_all.deb
	    gdebi --non-interactive loggerhead_1.19~bzr477-1_all.deb
	fi
    fi
}

function backport_rpm_from_fedora_updates {
    rebuild_one_rpm --enablefedora --enablefedoraupdates $*
}

function backport_rpm_from_fedora {
    rebuild_one_rpm --enablefedora $*
}

function rebuild_rpm_from_centos {
    rebuild_one_rpm --rebuild $*
}

function rebuild_one_rpm {
    enablefedsrc=
    enablefed=
    if [ "$1" = "--enablefedora" ] ; then
	enablefedsrc="--enablerepo=fedora-source"
	enablefed="--enablerepo=fedora"
    	shift
    fi

    if [ "$1" = "--enablefedoraupdates" ] ; then
	enablefedsrc="--enablerepo=fedora-updates-source"
	enablefed="--enablerepo=fedora-updates"
    	shift
    fi

    rebuild=no
    if [ "$1" = "--rebuild" ] ; then
    	rebuild=yes
    	shift
    fi

    src=
    if [ "$1" = "--source-package" ] ; then
    	src=$2
    	shift
    	shift
    fi

    force=
    if [ "$1" = "--force" ] ; then
    	force=$1
    	shift
    fi

    target=$1
    shift
    others="$*"

    src=${src:-$target}

    rebuild_needed=no
    if [ $rebuild = yes ] ; then
	rebuild_needed=yes
    else
	for i in $target $others ; do
	    if ! yum list $i >/dev/null 2>&1; then
		rebuild_needed=yes
		break
	    fi
	done
    fi

    if [ $rebuild_needed = yes ] ; then
	yumdownloader $enablefedsrc --source $src

	for DEP in $DEPS ; do
	    if ! yum install -y $DEP ; then
		yumdownloader $enablefed $DEP
		if [ -e  $DEP-*.noarch.rpm ] ; then
		    yum install -y $DEP-*.noarch.rpm
		else
		    yum install -y $DEP-*.x86_64.rpm
		fi
	    fi
	done

	for i in $src-*.src.rpm ; do
	    if [ $rebuild = yes ] || [ ! -e "$i.done" ] ; then
		rpmbuild --rebuild $src-*.src.rpm
	    fi
	    mv -f "$i" "$i.done"
	done
	if [ -n "$REMOVEDEPS" ] ; then
	    : yum remove -y $REMOVEDEPS
	fi

	for i in $target $others ; do
	    yum remove -y $i
	done
	for i in $target $others ; do
	    yum install -y ~/rpmbuild/RPMS/*/$i-[0-9]*.*.rpm || rpm -i $force ~/rpmbuild/RPMS/*/$i-[0-9]*.*.rpm
	done
    else
	yum install -y $target $others
    fi
}

function backports_rpm {
    set -ex

    # Fedora/RHEL/CentOS version:
    os_version=$(rpm -q --qf "%{VERSION}" $(rpm -q --whatprovides redhat-release))

    if ! rpm -q fedora-release >/dev/null; then
	# EPEL - http://download.fedoraproject.org/pub/epel/6/i386/repoview/epel-release.html
	if ! rpm -q epel-release >/dev/null; then
	    case $os_version in
		6)
		    rpm -ivh http://rpmfind.net/linux/epel/6/i386/epel-release-6-8.noarch.rpm
		    ;;
		7)
		    rpm -ivh http://rpmfind.net/linux/epel/7/x86_64/e/epel-release-7-5.noarch.rpm
		    ;;
	    esac
	fi

	# Prepare manual backports
	cat <<'EOF' > /etc/yum.repos.d/fedora-source.repo
[fedora]
name=Fedora 20
failovermethod=priority
metalink=https://mirrors.fedoraproject.org/metalink?repo=fedora-20&arch=$basearch
enabled=0
gpgcheck=0
[fedora-updates]
name=Fedora 20 Updates
failovermethod=priority
metalink=https://mirrors.fedoraproject.org/metalink?repo=updates-released-f20&arch=$basearch
enabled=0
gpgcheck=0
[fedora-source]
name=Fedora 20 - Source
failovermethod=priority
metalink=https://mirrors.fedoraproject.org/metalink?repo=fedora-source-20&arch=$basearch
enabled=0
gpgcheck=0
[fedora-updates-source]
name=Fedora 20 Updates - Source
failovermethod=priority
metalink=https://mirrors.fedoraproject.org/metalink?repo=updates-released-source-f20&arch=$basearch
enabled=0
gpgcheck=0
EOF
	yum install -y yum-utils # yumdownloader
	if [ ! -e /usr/bin/rpmbuild ] ; then
	    yum install -y rpm-build
	fi
    fi

    yum install -y gcc gcc-c++ postgresql-devel python-devel libpng-devel sqlite-devel autoconf libtool systemd-devel freetype-devel

    DEPS="xmlto"
    REMOVEDEPS=$DEPS
    backport_rpm_from_fedora libnss-pgsql

    DEPS=""
    REMOVEDEPS=$DEPS
    backport_rpm_from_fedora moin

    case $os_version in
	7)
	    DEPS="gd-devel byacc libjpeg-devel flex"
	    REMOVEDEPS=$DEPS
	    backport_rpm_from_fedora cvsgraph

	    DEPS="python-pygments"
	    REMOVEDEPS=$DEPS
	    backport_rpm_from_fedora viewvc

	    # Backport httpd-itk from Fedora 20
	    # until https://bugzilla.redhat.com/show_bug.cgi?id=1059143 is fixed
	    # …yes, it requires pulling in a lot of stuff :-(
	    #
	    #
	    DEPS="libuuid-devel lksctp-tools-devel"
	    REMOVEDEPS=$DEPS
	    backport_rpm_from_fedora_updates --source-package apr apr-1.5.1 apr-devel-1.5.1

	    DEPS="jasper-devel"
	    REMOVEDEPS=$DEPS
	    backport_rpm_from_fedora libicns libicns-utils

	    DEPS="kde-filesystem hardlink"
	    REMOVEDEPS=$DEPS
	    backport_rpm_from_fedora_updates --source-package generic-logos --force generic-logos-httpd

	    DEPS="xmlto libselinux-devel lua-devel pcre-devel openssl-devel libxml2-devel apr-util-devel"
	    REMOVEDEPS=$DEPS
	    backport_rpm_from_fedora_updates --source-package httpd httpd-tools-2.4.10 httpd-2.4.10 httpd-devel-2.4.10 mod_ssl-2.4.10

	    DEPS=""
	    REMOVEDEPS=$DEPS
	    backport_rpm_from_fedora_updates --source-package httpd-itk httpd-itk-2.4.7.01

	    DEPS=""
	    REMOVEDEPS=$DEPS
	    rebuild_rpm_from_centos mod_wsgi

	    if ! rpm -qR php | grep -q httpd.*2.4.10 ; then
		if rpm -qi mariadb-libs | grep -q 5\.5\. && ! rpm -qi mariadb-libs | grep -q 5\.5\.37 ; then
		    yum downgrade -y mariadb-libs
		fi

		DEPS="bzip2-devel curl-devel pam-devel libstdc++-devel libedit-devel libtool-ltdl-devel libzip-devel systemtap-sdt-devel firebird-devel net-snmp-devel libxslt-devel t1lib-devel libvpx-devel gmp-devel tokyocabinet-devel libmcrypt-devel libtidy-devel freetds-devel aspell-devel recode-devel libicu-devel enchant-devel libc-client-devel openldap-devel unixODBC-devel mariadb-devel-5.5.37 exim"
		REMOVEDEPS=$DEPS
		rebuild_rpm_from_centos --source-package php php-common php-cli php php-pdo php-pgsql php-process php-ldap php-gd

		if rpm -qi mariadb-libs | grep -q 5\.5\.37 ; then
		    yum upgrade -y mariadb-libs
		fi
	    fi
	    #
	    #
	    # End of backport for httpd-itk + related packages
	    ;;
    esac

    DEPS="dos2unix"
    REMOVEDEPS=$DEPS
    backport_rpm_from_fedora php-nusoap

    DEPS="php-channel-htmlpurifier"
    REMOVEDEPS=""
    backport_rpm_from_fedora php-htmlpurifier-htmlpurifier

    DEPS=""
    REMOVEDEPS=$DEPS
    backport_rpm_from_fedora mediawiki

    # TODO: postfix: rebuild from RHEL/CentOS sources with pgsql enabled,
    # so we can test mta-postfix
}
