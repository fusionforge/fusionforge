<?php // -*-php-*-
rcs_id('$Id: actionbar.tmpl 6234 2008-09-05 15:18:45Z vargenau $');
?>

<?php 
$curuserprefs = $user->getPreferences();
$dbh = $request->getDbh();
$isAdmin = $user->isAdmin();
$pagename = $page->getName();
$isActionPage = $request->_isActionPage($pagename, false);
$isBrowse = $request->getArg('action') == 'browse';
?>

  <div id="actionbuttons">
    <table cellpadding="0" cellspacing="0">
    <tr>

    <?php if (!string_ends_with($pagename, _("/Discussion"))) { ?>
    <?php $talk = new WikiPageName('Talk:'.$pagename); ?>
      <td class="bold">
      <?= Button(array(),
                       $isActionPage ? _("Action Page") : _("Page"), 
                       $talk->getParent(), array('title' => "Page")) ?>
      </td>
      <td class="spacer">&nbsp;</td>
      <?php if (!$isActionPage) { ?>
        <?php if ($dbh->isWikiPage($talk->getName())) { ?>
          <td>
          <?= Button(array('action'=>'browse'), _("Discussion"), $talk->getName()) ?>
          </td>
        <?php } else { ?>
          <td>
          <?= Button(array('action'=>'create',
                                 'template'=>_("TemplateTalk")),
                           _("Discussion"), $talk->getName()) ?>
          </td>
        <?php } ?>
      <?php } ?>
    <?php } else {
      $talk = new WikiPageName($pagename); ?>
      <td>
      <?= Button(array(),$isActionPage ? _("Action Page") : _("Page"), $talk->getParent(), array('title' => "View the page")) ?>
      </td>
      <td class="spacer">&nbsp;</td>
      <td class="bold">
      <?= Button(array(),_("Discussion"), $talk->getName()) ?>
      </td>
    <?php } ?>

    <td class="spacer">&nbsp;</td>
    <td class="spacer">&nbsp;</td>

    <?php if ((mayAccessPage('edit', $page->getName())) and $revision) { ?>
      <td class="bold"><?= Button("edit", $dbh->isWikiPage($page->getName()) ? ($revision->isCurrent() ? _("Edit") : _("Edit Old Revision")) : _("Create Page")) ?></td>
    <?php } else if ($dbh->isWikiPage($page->getName())) { ?>
      <td><?= Button("viewsource", _("View Source")) ?></td>
    <?php } ?>

    <?php if ($dbh->isWikiPage($page->getName())) { ?>

    <td class="spacer">&nbsp;</td>
    <td><?= Button("PageHistory", _("History")) ?></td>

    <?php if ($curuserprefs->get('diffMenuItem')) { ?>
      <td class="spacer">&nbsp;</td>
      <td><?= Button("diff", _("Last Difference")) ?> </td>
    <?php } ?>

    <?php if ($curuserprefs->get('revertMenuItem')) { ?>
      <td class="spacer">&nbsp;</td>
      <td><?= Button('revert',_("Revert"), $revision->isCurrent() ? $page->GetRevisionBefore() : $revision) ?></td>
    <?php } ?>

      <td class="spacer">&nbsp;</td>
      <td><?= Button("PageInfo", _("Page Info")) ?></td>

      <td class="spacer">&nbsp;</td>
      <td><?= Button(array('action'=>'BackLinks'), _("Back Links"),$page->getName()) ?></td>

    <?php if (defined('USE_EXTERNAL_HTML2PDF') and USE_EXTERNAL_HTML2PDF) { ?> 
      <?php if ($curuserprefs->get('pdfMenuItem')) { ?>
        <td class="spacer">&nbsp;</td>
        <td><?= Button("pdf") ?></td>
      <?php } ?>
    <?php } ?>

    <td class="spacer">&nbsp;</td>
    <td class="spacer">&nbsp;</td>

    <?php if ($user->isAdmin() or mayAccessPage('change', $page->getName())) { ?>
      <?php if ($curuserprefs->get('lockMenuItem')) { ?>
        <?php if ($page->get('locked')) { ?>
          <td><?= Button('unlock', _("Unlock")) ?></td>
        <?php } else { ?>
          <td><?= Button('lock', _("Lock")) ?></td>
        <?php } ?>
        <td class="spacer">&nbsp;</td>
      <?php } ?>

      <?php if (ENABLE_PAGEPERM and mayAccessPage('change', $page->getName())) { ?>
        <?php if ($curuserprefs->get('chownMenuItem')) { ?>
          <td><?= Button('chown', _("Change Owner")) ?></td>
          <td class="spacer">&nbsp;</td>
        <?php } ?>

        <?php if ($curuserprefs->get('setaclMenuItem')) { ?>
          <td><?= Button('setacl', _("Access Rights")) ?></td>
          <td class="spacer">&nbsp;</td>
        <?php } ?>
      <?php } ?>
    <?php } ?>

    <?php if (($user->isAdmin() or mayAccessPage('rename', $page->getName())) && $revision) { ?>
        <td><?= Button('rename', _("Rename")) ?></td>
        <td class="spacer">&nbsp;</td>
    <?php } ?>

    <?php if (($user->isAdmin() or mayAccessPage('purge', $page->getName())) && $revision) { ?>
        <td><?= Button('purge', _("Purge")) ?></td>
        <td class="spacer">&nbsp;</td>
    <?php } ?>

<?php if ((DEBUG and $request->getArg('action') == 'browse') || $user->isAdmin()) { ?> 
    <!-- Buttons really only for debugging -->
<?php
    if (DEBUG & _DEBUG_SQL and USECACHE) {
      $PurgeCache = Button(array('nocache' => 'purge'),
                     _("PurgeHtmlCache"), $page->getName());
      $PurgeCache->addTooltip(_("Purge HTML cache for this page. Regenerate from WikiMarkup when next accessed."));
?>
      <td><?= $PurgeCache ?></td>
<?php } ?>
    <!-- End debugging buttons -->
<?php } ?>
    <?php } ?>
  </tr>
  </table>
  </div>
