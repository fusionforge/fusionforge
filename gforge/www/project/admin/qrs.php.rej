***************
*** 53,64 ****
  			$feedback .= ' | Package Doesn\'t Exist Or Isn\'t Yours ';
  			echo db_error();
  		} else {
  			//package_id was fine - now insert the release
  			$res=db_query("INSERT INTO frs_release (package_id,name,notes,changes,status_id,preformatted,release_date,released_by) ".
  				"VALUES ('$package_id','$release_name','$release_notes','$release_changes','$status_id','$preformatted','". time() ."','". user_getid() ."')");
  			if (!$res) {
  				$feedback .= ' | Adding Release Failed ';
  				echo db_error();
  				//insert failed - go back to definition screen
  			} else {
  				//release added - now show the detail page for this new release
--- 56,69 ----
  			$feedback .= ' | Package Doesn\'t Exist Or Isn\'t Yours ';
  			echo db_error();
  		} else {
+ 			db_begin();
  			//package_id was fine - now insert the release
  			$res=db_query("INSERT INTO frs_release (package_id,name,notes,changes,status_id,preformatted,release_date,released_by) ".
  				"VALUES ('$package_id','$release_name','$release_notes','$release_changes','$status_id','$preformatted','". time() ."','". user_getid() ."')");
  			if (!$res) {
  				$feedback .= ' | Adding Release Failed ';
  				echo db_error();
+ 				db_rollback();
  				//insert failed - go back to definition screen
  			} else {
  				//release added - now show the detail page for this new release
***************
*** 80,102 ****
  			Fifth insert it into the database
  		*/
  		$group_unix_name=group_getunixname($group_id);
- 		$project_files_dir=$FTPFILES_DIR.$group_unix_name;
  
- 		if ($file_name) {
  			// Check to see if the user uploaded a file instead of selecting an existing one.
  			// If so then move it to the 'incoming' dir where we proceed as usual.
- 			if( $file_name == "qrs_newfile" ) {
- 				$file_name = $userfile_name;
- 
- 				if (is_file($userfile) && file_exists($userfile)) {
- 					$new_userfile = explode("tmp/", $userfile);
- 					$userfile = $new_userfile[1];
- 					exec ("/usr/local/bin/tmpfilemove $userfile $userfile_name",$exec_res);
- 					if ($exec_res[0]) {
- 						echo '<H3>' . $exec_res[0],$exec_res[1] . '</H3><P>';
- 					}
- 				}
- 			}
  			$feedback .= ' Adding File ';
  			//see if this release belongs to this project
  			$res1=db_query("SELECT frs_package.package_id FROM frs_package,frs_release ".
--- 85,95 ----
  			Fifth insert it into the database
  		*/
  		$group_unix_name=group_getunixname($group_id);
  
+ 		if ($userfile && is_uploaded_file($userfile)) {
  			// Check to see if the user uploaded a file instead of selecting an existing one.
  			// If so then move it to the 'incoming' dir where we proceed as usual.
+ 			$file_name = $userfile_name;
  			$feedback .= ' Adding File ';
  			//see if this release belongs to this project
  			$res1=db_query("SELECT frs_package.package_id FROM frs_package,frs_release ".
***************
*** 132,172 ****
  					if (!$res1 || db_numrows($res1) < 1) {
  
  						/*
- 							move the file to the project's fileserver directory
  						*/
- 						clearstatcache();
- 						if (is_file($FTPINCOMING_DIR.'/'.$file_name) && file_exists($FTPINCOMING_DIR.'/'.$file_name)) {
- 							//move the file to a its project page using a setuid program
- 							exec ("/usr/local/bin/fileforge $file_name ".$group_unix_name,$exec_res);
- 							if ($exec_res[0]) {
- 								echo '<h3>'.$exec_res[0],$exec_res[1].'</H3><P>';
- 							}
  							//add the file to the database
  							$res=db_query("INSERT INTO frs_file ".
  								"(release_time,filename,release_id,file_size,post_date, type_id, processor_id) ".
  								"VALUES ('$now','$file_name','$release_id','"
- 								. filesize("$project_files_dir/$file_name") 
  								. "','$now', '$type_id', '$processor_id') ");
  							if (!$res) {
  								$feedback .= " | Couldn't Add FileName: $file_name ";
  								echo db_error();
  							} else {
  								// Finally, send out email notification
  								$frs = new FRS($group_id);
- 						                $frs->frsSendNotice($group_id, $release_id, $package_id);
- 						                if( !$frs->isError() ) {
- 					                                $feedback .= '<br>Email Notice Sent';
  								}
- 								?>
- 								<p>
- 								Please note that file(s) may not appear immediately
- 								on the <a href="/project/showfiles.php?group_id=<?php echo $group_id;?>">
- 								download page</a>. Allow several hours for propogation.
- 								</p>
- 								<?php
  							}
- 						} else {
- 							$feedback .= " | FileName Invalid Or Does Not Exist: $file_name ";
  						}
  					} else {
  						$feedback .= " | FileName Already Exists For This Project: $file_name ";
--- 126,167 ----
  					if (!$res1 || db_numrows($res1) < 1) {
  
  						/*
+ 							Move the file into place
  						*/
+ 						$new_file=$sys_upload_dir.$group_unix_name.'/'.$userfile_name;
+ 						system("/bin/mkdir $sys_upload_dir$group_unix_name/");
+ 						if (!move_uploaded_file($userfile, $new_file)) {
+ 							$feedback .= ' | Could Not Move Uploaded File ';
+ 							db_rollback();
+ 						} else {
  							//add the file to the database
  							$res=db_query("INSERT INTO frs_file ".
  								"(release_time,filename,release_id,file_size,post_date, type_id, processor_id) ".
  								"VALUES ('$now','$file_name','$release_id','"
+ 								. filesize($new_file) 
  								. "','$now', '$type_id', '$processor_id') ");
  							if (!$res) {
  								$feedback .= " | Couldn't Add FileName: $file_name ";
  								echo db_error();
+ 								db_rollback();
  							} else {
  								// Finally, send out email notification
  								$frs = new FRS($group_id);
+ 						        $frs->frsSendNotice($group_id, $release_id, $package_id);
+ 						        if($frs->isError() ) {
+ 									$feedback .= ' | '.$frs->getErrorMessage();
+ 								} else {
+ 						           	$feedback .= '<br>Email Notice Sent';
+ 									?>
+ 									<p>
+ 									Please note that file(s) may not appear immediately
+ 									on the <a href="/project/showfiles.php?group_id=<?php echo $group_id;?>">
+ 									download page</a>. Allow several hours for propogation.
+ 									</p>
+ 									<?php
+ 									db_commit();
  								}
  							}
  						}
  					} else {
  						$feedback .= " | FileName Already Exists For This Project: $file_name ";
***************
*** 242,269 ****
  			<H4>File Name:</H4>
  		</TD>
  		<TD>
- <font color="red"><b>NOTE: In some browsers you must select the file in the file-upload dialog and click "OK".  Double-clicking doesn't register the file.</b></font><br>
- <?php
- 	$dirhandle = opendir($FTPINCOMING_DIR);
- 
- 	echo '<SELECT NAME="file_name">';
- 	echo '	<OPTION VALUE="qrs_newfile">Select a file</OPTION>';
- 	//iterate and show the files in the upload directory
- 	while ($file = readdir($dirhandle)) {
- 		if (!ereg('^\.',$file[0])) {
- 			$atleastone = 1;
- 			print '<OPTION value="'.$file.'">'.$file.'</OPTION>';
- 		}
- 	}
- 	echo '</SELECT> Or, upload a new file: <input type="file" name="userfile"  size="30">';
- 	if (!$atleastone) {
- 		print '<h3>No available files</H3>
- 			<P>
- 			You can upload files using FTP to <B>upload.sourceforge.net</B> 
- 			in the <B>/incoming</B> directory, then hit <B>Refresh View</B>.';
- 	}
- ?>
- 
  		</TD>
  	</TR>
  	<TR>
--- 238,246 ----
  			<H4>File Name:</H4>
  		</TD>
  		<TD>
+ 		<font color="red"><b>NOTE: In some browsers you must select the file in 
+ 		the file-upload dialog and click "OK".  Double-clicking doesn't register the file.</b></font><br>
+ 		Upload a new file: <input type="file" name="userfile"  size="30">
  		</TD>
  	</TR>
  	<TR>
