<?php

require_once('pre.php');

class AttachManager extends Error {
	
	var $attachs = array(); //the attached files
	var $msg_id; //the msg_id that links to the attachs
	var $user_id,$dateline,$filename,$filedata,$filesize,$visible,$filehash,$posthash;
	var $messages = array();
	
	function Setmsgid($id) {
		$this->msg_id = $id;
	}
	
	function Getmessages() {
		return $this->messages;
	}
	
	function fillvalues($user_id,$dateline,$filename,$filedata,$filesize,$visible,$filehash,$posthash) {
		$this->user_id = $user_id;
		$this->dateline = $dateline;
		$this->filename = $filename;
		$this->filedata = $filedata;
		$this->visible = $visible;
		$this->filehash = $filehash;
		$this->posthash = $posthash;
	}
	
	
	/**
	* Function PrintHelperFunctions
	*
	*
	* @return 	returns the javascript helper functions
	*/
	
	function PrintHelperFunctions() {
		return '<script type="text/javascript">
		
		function confirmDel() {
			var agree=confirm("Proceed with deletion? ");
			if (agree) return true ;
			else return false ;
		}
		
		function manageattachments(url,del) {
			var newwindow;
			if (del=="yes") {
				if (!confirmDel())
					return;
			}
			newwindow = window.open(url, \'Attach\', \'statusbar=no,menubar=no,toolbar=no,scrollbars=yes,resizable=yes,width=600,height=480\');
			if (window.focus) {newwindow.focus()}
		}
		</script>';
	}
	
	 /**
	 * Function PrintAttachLink
	 *
	 * @param 	int		The message id.
	 *
	 * @return 	returns link to attachment /delete if corresponding; else returns a message about no attachment found
	 */
	function PrintAttachLink($msg_id) {
		
		//ask if the message has an attachment

		$sql = "SELECT attachmentid,filename,userid FROM forum_attachment where msg_id=$msg_id";
		$res = db_query($sql);
		if ($res) {
			$attachid = db_result($res,0,'attachmentid');
		}
		if ($attachid) {
			$attach = "
			<a href=\"javascript:manageattachments('/forum/attachment.php?attachid=$attachid','no');\">" . html_image('ic/cfolder15.png',"15","13",array("border"=>"0")) . db_result($res,0,'filename') . "</a>";
			$attach_userid = db_result($res,0,'userid');
			if (user_getid() == $attach_userid) { //only permit the user who created the attach to delete it
				$attach .= "     <a href=\"javascript:manageattachments('/forum/attachment.php?attachid=$attachid&attach_userid=$attach_userid&delete=yes','yes');\">" .  "<font size=\"-3\">delete</font></a>";
			}
		}	else {
			$attach = html_image('ic/cfolder15.png',"15","13",array("border"=>"0")) . "No attachment found";
		}
		
		return $attach;
	}
	
	function attach($attach) {
		global $Language;
		global $_FILES;
		
		$sql = "SELECT * FROM forum_attachmenttype";
		$res = db_query($sql);
		$attachtypes = array();
		
		//fill the datastore array with the supported filetypes
		global $sys_db_row_pointer;
		for ($i=0;$i<db_numrows($res);$i++) {
			$aux = db_fetch_array($res);
			$attachtypes[$aux[0]] = $aux;
		}
		
		
	
		$attachment = trim($attach['tmp_name']);
		$attachment_name = trim($attach['name']);
		$attachment_size = trim($attach['size']);
		
		
		//TODO algun control de filesize
		
		if ($attachment == 'none' OR empty($attachment) OR empty($attachment_name))
		{
			$this->messages[] = $Language->getText('forum_attachmngr','errnofile');
			return; //no point in continuing if there´s no file
		}
		
		$attachment_name2 = strtolower($attachment_name);
		$extension = substr(strrchr($attachment_name2, '.'), 1);
		
		if (!$attachtypes["$extension"] OR !$attachtypes["$extension"]['enabled'])
		{
			// invalid extension
			$this->messages[] = $Language->getText('forum_attachmngr','err_inv_ext');
		}
		
		$maxattachsize = $attachtypes["$extension"]['size'];
		$filesize = filesize($attachment);
		
		if ($maxattachsize != 0 AND $filesize > $maxattachsize)
		{
			// too big
			@unlink($attachment);
			$this->messages[] = $Language->getText('forum_attachmngr','err_toobig');
		}
		
		if (!is_uploaded_file($attachment) || !($filestuff = @file_get_contents($attachment)) )
		{
			$this->messages[] = $Language->getText('forum_attachmngr','err_upload');
		}
		
		if (!session_loggedin()) {
			$user_id = 100;
		}	else {
			$user_id = user_getid();
		}
		
		$result=db_query("SELECT max(msg_id) AS id FROM forum");
		if (!$result || db_numrows($result) < 1) {
			$this->messages[] = $Language->getText('forum_attachmngr','err_msgid');
			@unlink($attachment);
		} else {
			$this->msg_id = db_result($result,0,0);
			// add to db
			$sql = "INSERT INTO forum_attachment (userid, dateline, filename, filedata, filesize, visible, msg_id , filehash)
					VALUES 
					( $user_id , " . time() . ", '" . addslashes($attachment_name) . "',
					'" .  base64_encode($filestuff) . "', $filesize, 1, $this->msg_id,  '" . addslashes(md5($filestuff)) . "')";
			if (db_query($sql)) {
				$this->messages[] = $Language->getText('forum_attachmngr','uploadok');
			}	else {
				$this->messages[] = $Language->getText('forum_attachmngr','upload_notok');
			}
			
			@unlink($attachment);
		}
	}
	
}


?>