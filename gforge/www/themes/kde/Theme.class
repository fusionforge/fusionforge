<?php
/*
 * KDE like theme.
 *
 * Copyright (c) 2003 GForge Development Team.
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License
 * as published by the Free Software Foundation; either version 2
 * of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
 *
 * All of the icons this theme uses were taken from KDE 3.1.
 *
 * @version   $Id$
 */

class Theme extends Layout {

	/**
	 * Theme() - Constructor
	 */
	function Theme() {
		// Parent constructor
		$this->Layout();

		// The root location for images
		$this->imgroot = '/themes/kde/images/';

		// The primary light background color
		// Alternate list
		$this->COLOR_LTBACK1= '#AAAADD';

		// The secondary light background color
		$this->COLOR_LTBACK2= '#AAAAFF';


		// The HTML box background color
		$this->COLOR_HTMLBOX_BACK = '#B6B6B6';

		// The color to separate HTML boxes
		$this->COLOR_HTMLBOX_SEP = '#000000';

		// Font Face Constants
		// The content font
		$this->FONT_CONTENT = 'Helvetica';
		// The HTML box title font
		$this->FONT_HTMLBOX_TITLE = 'Helvetica';
		// The HTML box title font color
		$this->FONTCOLOR_HTMLBOX_TITLE = '#72A5D8';
		// The content font color
		$this->FONTCOLOR_CONTENT = '#202020';
		//The smaller font size
		$this->FONTSIZE_SMALLER='smaller';
		//The smallest font size
		$this->FONTSIZE_SMALLEST='x-small';
		//The HTML box title font size
		$this->FONTSIZE_HTMLBOX_TITLE = 'x-small';


		// height of a tab (ie the size of the background
		// image), 23 is specified in the style guide and so
		// the background images were drawn for that size,
		// changing this will lead to the images being cropped
		// or tiled, either will look bad.
		$this->TAB_HEIGHT=32;


		// the following are not used in this theme, but have
		// been set to obnoxious colors to help debug any new
		// pages that make assumptions about a theme...  The
		// content background color
		$this->COLOR_CONTENT_BACK= '#0000FF';
		// The background color
		$this->COLOR_BACK= '#00FF00';
		// The HTML box title color
		$this->COLOR_HTMLBOX_TITLE = '#FF0000';

	}

	/**
	 *	header() - "steel theme" top of page
	 *
	 * @param	array	Header parameters array
	 */
	function header($params) {
		global $Language, $sys_name;

		if (!$params['title']) {
			$params['title'] = "$sys_name";
		} else {
			$params['title'] = "$sys_name: " . $params['title'];
		}

		print '<?xml version="1.0" encoding="' . $Language->getEncoding(). '"?>';

		?>

<!DOCTYPE html
	PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="<?php echo $Language->getLanguageCode(); ?>">

  <head>
	<meta http-equiv="Content-Type" content="text/html; charset=<?php echo $Language->getEncoding(); ?>" />
	<title><?php echo $params['title']; ?></title>
	<script language="JavaScript" type="text/javascript">
	<!--
	function help_window(helpurl) {
		HelpWin = window.open( '<?php echo ((session_issecure()) ? 'https://'.
			$GLOBALS['sys_default_domain'] : 'http://'.$GLOBALS['sys_default_domain']); ?>' + helpurl,'HelpWindow','scrollbars=yes,resizable=yes,toolbar=no,height=400,width=400');
	}
	// -->
	</script>
<?php

/*
	WARNING - changing this font call can affect
	INTERNATIONALIZATION
*/
		//gets font from Language Object
		// try and use the system font first...we'll risk I18N issues
		$site_fonts='Helvetica,'.$GLOBALS['Language']->getFont();

	?>

<style type="text/css">
	<!--
	BODY {
		margin-top: 3px;
		margin-left: 3px;
		margin-right: 3px;
		margin-bottom: 3px;
		background-color: #858aff;
	}

	OL,UL,P,BODY,TR,TD,TH,FORM {
		font-family: <?php echo $site_fonts; ?>;
		font-size:<?php echo $this->FONTSIZE; ?>;
		color: <?php echo $this->FONTCOLOR_CONTENT ?>;
	}

	TD.projectname {
		font-size: x-large;
		font-style: italic;
		font-variant: small-caps;
		text-align: center;
	}

	TD.logo {
		text-align: left;
	}

	TD.searchcell {
		text-align: center;
		vertical-align: middle;
	}

	TD.toolbar {
		text-align: right;
	}

	TR.toolbar {
		vertical-align: middle;
	}

	INPUT.searchbutton {
		vertical-align: middle;
	}

	SELECT.searchbox {
		vertical-align: baseline;
		font-size: <?php echo $this->FONTSIZE_SMALLER; ?>;
	}

	INPUT.searchbox {
		veritcal-align: baseline;
		font-size: <?php echo $this->FONTSIZE_SMALLER; ?>;
	}

/* give the rule a bit of extra space (above and below), since its being used to divide
   sections on some pages (project summary) */
	HR { margin: 5px 0px 5px 0px }


	H1 { font-size: x-large; font-family: <?php echo $site_fonts; ?>; }
	H2 { font-size: large; font-family: <?php echo $site_fonts; ?>; }
	H3 { font-size: medium; font-family: <?php echo $site_fonts; ?>; }
	H4 { font-size: small; font-family: <?php echo $site_fonts; ?>; }
	H5 { font-size: x-small; font-family: <?php echo $site_fonts; ?>; }
	H6 { font-size: xx-small; font-family: <?php echo $site_fonts; ?>; }

	PRE,TT { font-family: courier,sans-serif }

	A:link { text-decoration:none; color:#000080 }
	A:visited { text-decoration:none color:#551A8B}
	A:active { text-decoration:none; color:#00ff00 }
	A:hover { text-decoration:underline; color:#0000FF }

	.titlebar { color: #000000; text-decoration: none; font-weight: bold; }


	A.tablink {
		color: #000000;
		text-decoration: none;
		font-weight: bold;
		font-size: <?php echo $this->FONTSIZE_SMALLER; ?>;
	}
	A.tablink:visited {
		color: #000000;
		text-decoration: none;
		font-weight: bold;
		font-size: <?php echo $this->FONTSIZE_SMALLER; ?>;
	}
	A.tablink:hover {
		text-decoration: none;
		color: #000000;
		font-weight: bold;
		font-size: <?php echo $this->FONTSIZE_SMALLER; ?>;
	}
	A.tabsellink {
		color: #000000;
		text-decoration: none;
		font-weight: bold;
		font-size: <?php echo $this->FONTSIZE_SMALLER; ?>;
	}
	A.tabsellink:visited {
		color: #000000;
		text-decoration: none;
		font-weight: bold;
		font-size: <?php echo $this->FONTSIZE_SMALLER; ?>;
	}
	A.tabsellink:hover {
		text-decoration: none;
		color: #000000;
		font-weight: bold;
		font-size: <?php echo $this->FONTSIZE_SMALLER; ?>;
	}

	A.showsource {
		color: #000000;
		text-decoration: none;
		font-size: <?php echo $this->FONTSIZE_SMALLER; ?>;
	}
	A.showsource:visited {
		color: #000000;
		text-decoration: none;
		font-size: <?php echo $this->FONTSIZE_SMALLER; ?>;
	}
	A.showsource:hover {
		color: #000000;
		text-decoration: none;
		font-size: <?php echo $this->FONTSIZE_SMALLER; ?>;
	}
	-->
</style>

</head>

<body>

<!-- Toolbar at very top -->
<table border="0" width="100%" cellspacing="0" cellpadding="0">

	<tr class="toolbar">
		<!-- Logo on the left -->
		<td class="logo">
			<a href="/" title="Homepage"><img name="logo" border="0" src="<?php echo $this->imgroot.'toolbar/logo.png'; ?>" alt="GForge Logo" /></a>
		</td>
		<!-- Search box in the middle -->
		<td class="searchcell">
			<?php echo $this->searchBox(); ?>

		</td>
		<!-- Toolbar on right -->
		<td class="toolbar"><?php
			global $Language;
			$hint = $Language->getText('group','short_homepage');
			echo $this->makeToolbarIcon("/", $hint, "homepage.png");
			if (session_loggedin()) {
				$hint = $Language->getText('menu',
							   'mypage');
				echo $this->makeToolbarIcon("/my/",
							    $hint,
							    "my_page.png");
				$hint = $Language->getText('menu',
							   'my_account');
				echo $this->makeToolbarIcon("/account/",
							    $hint,
							    "my_account.png");
				if ($GLOBALS['HTTP_POST_VARS']) {
					$hint = $Language->getText('menu',
								  'bookmark_not_allowed');
					echo '
			<img src="'.$this->imgroot.'toolbar/bookmark_add_dark.png" alt="'.$hint.'" border="0" />';
				} else {
					$bookmark_title=urlencode(str_replace($sys_name.': ', '', $params['title'] ? $params['title'] : "Untitled"));
					$hint = $Language->getText('menu',
								   'bookmark_page');
					echo $this->makeToolbarIcon("/my/bookmark_add.php?bookmark_url=".urlencode($GLOBALS['REQUEST_URI'])."&amp;bookmark_title=$bookmark_title",
								    $hint,
								    "bookmark_add.png");
				}
				if (user_ismember(1,'A')) {
					$hint = $Language->getText('group',
								   'short_admin');
					echo $this->makeToolbarIcon("/admin/",
								    $hint,
								    "admin.png");
				}
			}
			$hint = $Language->getText('menu',
						   'software_map');
			echo $this->makeToolbarIcon("/softwaremap/",
						    $hint,
						    "project_tree.png");
			$hint = $Language->getText("menu",
						   "code_snippet");
			echo $this->makeToolbarIcon("/snippet/",
						    $hint,
						    "snippets.png");
			$hint = $Language->getText("menu",
						   "project_help_wanted");
			echo $this->makeToolbarIcon("/people/",
						    $hint,
						    "project_help.png");

			if (session_loggedin()) {
				$hint = $Language->getText("menu",
							   "logout");
				echo $this->makeToolbarIcon("/account/logout.php",
							    $hint,
							    "logout.png");
			} else {
				$hint = $Language->getText("menu",
							   "login");
				echo $this->makeToolbarIcon("/account/login.php",
							    $hint,
							    "login.png");
				$hint = $Language->getText("menu",
							   "newaccount");
				echo $this->makeToolbarIcon("/account/register.php",
							    $hint,
							    "new_account.png");
			}

			?>

		</td>
	</tr>
</table>		<!-- End of top toolbar -->

<!-- Page body -->
<table border="0" width="100%" cellspacing="0" cellpadding="0">

	<tr>
		<td>&nbsp;</td>
		<td valign="top" width="99%" colspan="3">
			<!-- Inner Tabs / Shell -->

			<table border="0" width="100%" cellspacing="0" cellpadding="0">

<?php


		  if ($params['group']) {

?>
			<tr>
				<td colspan="3" class="projectname">
				<?php
					$project =& group_get_object($params['group']);
					if ($project && is_object($project)
					    && !$project->isError()
					    && $project->isProject()) {
						echo $project->getPublicName();
					}
				?>
				</td>
			</tr>
			<tr>
				<td>&nbsp;</td>
				<td>
				<?php

				echo $this->projectTabs($params['toptab'],$params['group']);

				?>
				</td>
				<td>&nbsp;</td>
			</tr>
			<?php

}

?>

			<tr>
				<td></td>
				<td valign="top" width="99%">
	<?php
	}

	function footer($params) {

	?>

			<!-- end main body row -->


				</td>
				<td width="10"></td>
			</tr>
			</table>

		<!-- end inner body row -->

		</td>
		<td width="10"></td>
	</tr>
	<tr>
		<!-- some extra space to make it look nicer -->
		<td height="50">&nbsp;</td>
	</tr>
</table>
<?php
	global $sys_show_source;
	if ($sys_show_source) {
		global $SCRIPT_NAME;
		print '<a class="showsource" href="/source.php?file=' . $SCRIPT_NAME . '">Show Source</a>';
	}
?>

</body>
</html>
<?php

	}


	/**
	 * boxTop() - Top HTML box
	 *
	 * @param   string  Box title
	 * @param   bool	Whether to echo or return the results
	 * @param   string  The box background color
	 */
	function boxTop($title) {
		return '
		<!-- boxTop -->
		<table cellspacing="2" cellpadding="0" width="100%" border="0">
		<tr><td>

			<table cellspacing="2" cellpadding="0" width="100%" border="0" >
				<tr>
					<td colspan="2"><span class="titlebar">'.$title.'</span></td>
				</tr>
				<tr align="left" bgcolor="'. $this->COLOR_HTMLBOX_BACK .'">
					<td colspan="2" height="1"></td>
				</tr>
				<tr align="left">
					<td colspan="2">
		<!-- /boxTop -->';
	}

	/**
	 * boxMiddle() - Middle HTML box
	 *
	 * @param   string  Box title
	 * @param   string  The box background color
	 */
	function boxMiddle($title) {
		return '
				<!-- boxMiddle -->
				</td>
				</tr>
				<tr><td height="20" colspan="2">&nbsp;</td></tr>
				<tr>
					<td colspan="2"><span class="titlebar">'.$title.'</span></td>
				</tr>
				<tr align="left" bgcolor="'. $this->COLOR_HTMLBOX_BACK .'">
					<td colspan="2" height="1"></td>
				</tr>
				<tr>
					<td colspan="2">
				<!-- /boxMiddle -->';
	}

	/**
	 * boxGetAltRowStyle() - Get an alternating row style for tables
	 *
	 * @param			   int			 Row number
	 */
	function boxGetAltRowStyle($i) {
		switch ($i % 2) {
			case 0:
				return 'bgcolor="' . $this->COLOR_LTBACK1 . '"';
			case 1:
				return 'bgcolor="' . $this->COLOR_LTBACK2 . '"';
		}
	}

	/**
	 * boxBottom() - Bottom HTML box
	 *
	 * @param   bool	Whether to echo or return the results
	 */
	function boxBottom() {
		return '<!-- boxBottom -->
					</td>
				</tr>
			</table>
		</td></tr>
		<tr><td height="20" colspan="2">&nbsp;</td></tr>
		</table><p />';
	}

	/**
	 * listTableTop() - Takes an array of titles and builds the first row of a new table.
	 *
	 * @param	   array   The array of titles
	 * @param	   array   The array of title links
	 */
	function listTableTop ($title_arr,$links_arr=false) {
		$return = '
		<!-- listTableTop -->
		<table cellspacing="0" cellpadding="1" width="100%" border="0">
        <tr><td>
		<table width="100%" border="0" cellspacing="2" cellpadding="0">
			<tr>';

		$count=count($title_arr);
		if ($links_arr) {
			for ($i=0; $i<$count; $i++) {
				$return .= '
				<td align="left"><a class="titlebar" href="'.$links_arr[$i].'">'.$title_arr[$i].'</a></td>';
			}
		} else {
			for ($i=0; $i<$count; $i++) {
				$return .= '
				<td align="left">'.$title_arr[$i].'</td>';
			}
		}
		$return .= '
		</tr>
		<tr align="left" bgcolor="'. $this->COLOR_HTMLBOX_BACK .'">
			<td colspan="'.$count.'" height="1"></td>
		</tr>';
		return $return;
	}

	function tabGenerator($TABS_DIRS,$TABS_TITLES,$nested=false,$selected=false,$sel_tab_bgcolor='WHITE',$total_width='100%') {
		// The function captain, she be empty!
	}

	function projectTabs($toptab, $group) {
		global $Language;

		$project =& group_get_object($group);
		if (!$project || !is_object($project)) {
			return '';
		}
		if ($project->isError()) {
			return '';
		}
		if (!$project->isProject()) {
			return '';
		}

		// Summary
		if ($toptab == 'home') {
			$img = "summary.png";
		} else {
			$img = "summary_dark.png";
		}
		$hint = $Language->getText('group','short_summary');
		$return .= '

		<!-- projectTabs -->

		<table border="0" cellpadding="0" cellspacing="0" width="100%">
		<tr>'. $this->makeProjectIcon("/projects/".$project->getUnixName()."/",
					      $hint, $img);

		// Project admin
		if (user_ismember($group,'A')) {
			if ($toptab == 'admin') {
				$img = 'admin.png';
			} else {
				$img = 'admin_dark.png';
			}
			$hint = $Language->getText('group','short_admin');
			$return .= $this->makeProjectIcon("/project/admin/?group_id=$group",
							  $hint, $img);
		}

		// Fora
		if ($project->usesForum()) {
			if ($toptab == 'forums') {
				$img = 'forums.png';
			} else {
				$img = 'forums_dark.png';
			}
			$hint = $Language->getText('group','short_forum');
			$return .= $this->makeProjectIcon("/forum/?group_id=$group",
							  $hint, $img);
		}

		// Tracker
		if ($project->usesTracker()) {
			if ($toptab == 'tracker' || $toptab == 'bugs'
			    || $toptab == 'support' || $toptab == 'patch') {
				$img = 'tracker.png';
			} else {
				$img = 'tracker_dark.png';
			}

			$hint = $Language->getText('group', 'short_tracker');
			$return .= $this->makeProjectIcon("/tracker/?group_id=$group",
							  $hint, $img);
		}

		// Mail
		if ($project->usesMail()) {
			if ($toptab == 'mail') {
				$img = 'mail.png';
			} else {
				$img = 'mail_dark.png';
			}
			$hint = $Language->getText('group', 'short_mail');
			$return .= $this->makeProjectIcon("/mail/?group_id=$group",
							  $hint, $img);
		}

		// Tasks
		if ($project->usesPm()) {
			if ($toptab == 'pm') {
				$img = 'pm.png';
			} else {
				$img = 'pm_dark.png';
			}
			$hint = $Language->getText('group','short_pm');
			$return .= $this->makeProjectIcon("/pm/?group_id=$group",
							  $hint, $img);
		}

		// Docman
		if ($project->usesDocman()) {
			if ($toptab == 'docman') {
				$img = 'docman.png';
			} else {
				$img = 'docman_dark.png';
			}
			$hint = $Language->getText('group','short_docman');
			$return .= $this->makeProjectIcon("/docman/?group_id=$group",
							  $hint, $img);
		}

		// Surveys
		if ($project->usesSurvey()) {
			if ($toptab == 'surveys') {
				$img = 'surveys.png';
			} else {
				$img = 'surveys_dark.png';
			}
			$hint = $Language->getText('group','short_survey');
			$return .= $this->makeProjectIcon("/survey/?group_id=$group",
							  $hint, $img);
		}

		// News
		if ($project->usesNews()) {
			if ($toptab == 'news') {
				$img = 'news.png';
			} else {
				$img = 'news_dark.png';
			}
			$hint = $Language->getText('group','short_news');
			$return .= $this->makeProjectIcon("/news/?group_id=$group",
							  $hint, $img);
		}

		// CVS
		if ($project->usesCVS()) {
			if ($toptab == 'scm_index') {
				$img = 'cvs.png';
			} else {
				$img = 'cvs_dark.png';
			}
			$hint = $Language->getText('group','short_cvs');
			$return .= $this->makeProjectIcon("/scm/?group_id=$group",
							  $hint, $img);
		}

		// Downloads
		if ($project->usesFRS()) {
			if ($toptab == 'downloads') {
				$img = 'files.png';
			} else {
				$img = 'files_dark.png';
			}
			$hint = $Language->getText('group', 'short_files');
			$return .= $this->makeProjectIcon("/project/showfiles.php?group_id=$group",
							  $hint, $img);
		}

		return $return .= '
		</tr>
		</table>
		<!-- end tabGenerator -->';
	}

	function makeProjectIcon($url, $hint, $img) {
		return '
			<td align="center"><a href="'.$url.'" title="'.$hint.'"><img src="'.$this->imgroot.'project_icons/'.$img.'" alt="'.$hint.'" border="0" /></a></td>';
	}

	function makeToolbarIcon($url, $hint, $img) {
		return '
			<a href="'.$url.'" title="'.$hint.'"><img src="'.$this->imgroot.'toolbar/'.$img.'" alt="'.$hint.'" border="0" height="32" /></a>';
	}

	function searchBox() {
		global $Language,$words,$forum_id,$group_id,
			$group_project_id,$atid,$exact,$type_of_search;

		// if there is no search currently, set the default
		if ( ! isset($type_of_search) ) {
			$exact = 1;
		}

		print '<form action="/search/" method="post"'.$new_window.'>
			<select name="type_of_search" class="searchbox">';

		if ($atid && $group_id) {
			$group =& group_get_object($group_id);
			if ($group && is_object($group)) {
				$ath = new ArtifactTypeHtml($group,$atid);
				if ($ath && is_object($ath)) {
				print '
				<option value="artifact"'.( $type_of_search == 'artifact' ? ' selected="selected"' : '' ).'>'. $ath->getName() .'</option>';
				}
			}
		} else if ($group_id && $forum_id) {
			print '
				<option value="forums"'.( $type_of_search == 'forums' ? ' selected="selected"' : '' ).'>'.$Language->getText('searchbox','forum').'</option>';
		} else if ($group_id && $group_project_id) {
			print '
				<option value="task"'. ( $type_of_search == 'tasks' ? ' selected="selected"' : '').'>'.$Language->getText('searchbox','task').'</option>';
		}

		print '
				<option value="soft"'.( $type_of_search == 'soft' ? ' selected="selected"' : '' ).'>'.$Language->getText('searchbox','softwaregroup').'</option>';
		print '
				<option value="skill"'.( $type_of_search == 'skill' ? ' selected="selected"' : '' ).'>'.$Language->getText('searchbox','skill').'</option>';
		print '
				<option value="people"'.( $type_of_search == 'people' ? ' selected="selected"' : '' ).'>'.$Language->getText('searchbox','people').'</option>';
		print '
			</select>&nbsp;';

		print '
			<input type="text" size="12" name="words" value="'.$words.'" class="searchbox" />&nbsp;';
		print '
			<input type="image" name="Search" value="'.$Language->getText('searchbox','search').'" src="'.$this->imgroot.'toolbar/search.png" alt="'.$Language->getText('searchbox','search').'" class="searchbutton" />';

		if ( isset($forum_id) ) {
			print '
			<input type="hidden" value="'.$forum_id.'" name="forum_id" />';
		}
		if ( isset($group_id) ) {
			print '
			<input type="hidden" value="'.$group_id.'" name="group_id" />';
		}
		if ( isset($atid) ) {
			print '
			<input type="hidden" value="'.$atid.'" name="atid" />';
		}
		if ( isset($group_project_id) ){
			print '
			<input type="hidden" value="'.$group_project_id.'" name="group_project_id" />';
		}
		print '
			</form>';
	}



	/**
	 * multiTableRow() - create a mutlilevel row in a table
	 *
	 * @param	string	the row attributes
	 * @param	array	the array of cell data, each element is an array,
	 *                  	the first item being the text,
	 *                      the subsequent items are attributes
	 * @param	boolean is this row part of the title ?
	 *
	 */
	 function multiTableRow($row_attr, $cell_data, $istitle) {
		$return= '
		<!-- multiTableRow -->
		<tr '.$row_attr;
		if ( $istitle ) {
			$return .=' align="center" ';
		}
		$return .= '>';
		for ( $c = 0; $c < count($cell_data); $c++ ) {
			$return .='<td ';
			for ( $a=1; $a < count($cell_data[$c]); $a++) {
				$return .= $cell_data[$c][$a].' ';
			}
			$return .= '>';
			if ( $istitle ) {
				$return .='<span class="titlebar">';
			}
			$return .= $cell_data[$c][0];
			if ( $istitle ) {
				$return .='</span>';
			}
			$return .= '</td>';

		}
		$return .= '</tr>
		<!-- end multiTableRow -->
		';

		return $return;
	 }

}
?>
