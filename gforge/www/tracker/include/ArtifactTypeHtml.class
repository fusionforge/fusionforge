<?php
/**
  *
  * SourceForge Generic Tracker facility
  *
  * SourceForge: Breaking Down the Barriers to Open Source Development
  * Copyright 1999-2001 (c) VA Linux Systems
  * http://sourceforge.net
  *
  * @version   $Id$
  *
  */


require_once('common/tracker/ArtifactType.class');

class ArtifactTypeHtml extends ArtifactType {

	/**
	 *  ArtifactType() - constructor
	 *
	 *  @param $Group object
	 *  @param $artifact_type_id - the id # assigned to this artifact type in the db
	 */
	function ArtifactTypeHtml(&$Group,$artifact_type_id=false, $arr=false) {
		return $this->ArtifactType($Group,$artifact_type_id,$arr);
	}

	function header($params) {
		global $DOCUMENT_ROOT;

		$group_id= $this->Group->getID();

		//required by new site_project_header
		$params['group']=$group_id;
		$params['toptab']='tracker';
		$params['tabtext']=$this->getName();

		site_project_header($params);
		echo '<h3>Tracker: <a href="/tracker/?group_id='.$group_id.'&atid='.$this->getID().'">'.$this->getName().'</a></h3><p>';

		echo '<strong><a href="/tracker/?func=add&group_id='.$group_id.'&atid='. $this->getID() .'">Submit New</a>';
		echo ' | <a href="/tracker/?func=browse&group_id='.$group_id.'&atid='. $this->getID() .'">Browse</a>';
		if (session_loggedin()) {
			echo ' | <a href="/tracker/reporting/?group_id='.$group_id.'&atid='. $this->getID() .'">Reporting</a>';
		}
		echo ' | <a href="/tracker/admin/?group_id='.$group_id.'">Admin</a>';

		echo '</strong><p>';
		//echo '<HR NoShade SIZE="1" SIZE="90%">';
	}

	function footer($params) {
		site_project_footer($params);
	}

	function adminHeader($params) {
		echo $this->header($params);
		$group_id= $this->Group->getID();
		echo '<strong>Admin Functions: <a href="/tracker/admin/?group_id='.$group_id.'">Add/Browse Artifact Types</a>';
		echo ' | <a href="/tracker/admin/?group_id='.$group_id.'&atid='. $this->getID() .'">Edit/Update Options in: '. $this->getName() .'</a></strong>';
	}

	function categoryBox ($name='category_id',$checked='xzxz',$text_100='None') {
		return html_build_select_box ($this->getCategories(),$name,$checked,true,$text_100);
	}

	function artifactGroupBox ($name='artifact_group_id',$checked='xzxz',$text_100='None') {
		return html_build_select_box ($this->getGroups(),$name,$checked,true,$text_100);
	}

	function technicianBox ($name='assigned_to',$checked='xzxz',$show_100=true,$text_100='None') {
		return html_build_select_box ($this->getTechnicians(),$name,$checked,$show_100,$text_100);
	}

	function cannedResponseBox ($name='canned_response',$checked='xzxz') {
		return html_build_select_box ($this->getCannedResponses(),$name,$checked);
	}

	function statusBox ($name='status_id',$checked='xzxz',$show_100=false,$text_100='None') {
		return html_build_select_box($this->getStatuses(),$name,$checked,$show_100,$text_100);
	}

	function resolutionBox ($name='resolution_id',$checked='xzxz',$show_100=false,$text_100='None') {
		return html_build_select_box($this->getResolutions(),$name,$checked,$show_100,$text_100);
	}

	function showBrowseList ($result,$offset,$set='open') {
		global $sys_datefmt,$PHP_SELF;
		$group_id=$this->Group->getID();

		$title_arr=array();
		$title_arr[]='Request ID';
		$title_arr[]='Summary';
		$title_arr[]='Date';
		$title_arr[]='Assigned To';
		$title_arr[]='Submitted By';

		$IS_ADMIN=$this->userIsAdmin();


		if ($IS_ADMIN) {
			echo '
			<form name="artifactList" action="'. $PHP_SELF .'?group_id='.$group_id.'&atid='.$this->getID().'" METHOD="POST">
			<input type="hidden" name="func" value="massupdate">';
		}

		echo $GLOBALS['HTML']->listTableTop ($title_arr);

		$then=(time()-$this->getDuePeriod());
		$rows=db_numrows($result);
		for ($i=0; $i < $rows; $i++) {
			echo '
			<tr bgcolor="'. get_priority_color(db_result($result, $i, 'priority')) .'">'.
			'<td NOWRAP>'.
			($IS_ADMIN?'<input type="CHECKBOX" name="artifact_id_list[]" value="'.
			db_result($result, $i, 'artifact_id') .'"> ':'').
					db_result($result, $i, 'artifact_id') .
					'</td>'.
			'<td><a href="'.$PHP_SELF.'?func=detail&aid='. 
			db_result($result, $i, 'artifact_id').
			'&group_id='. $group_id .'&atid='.
			$this->getID().'">'. 
			db_result($result, $i, 'summary').
			'</a></td>'.
			'<td>'. (($set != 'closed' && db_result($result, $i, 'date') < $then)?'<strong>* ':'&nbsp; ') . date($sys_datefmt,db_result($result, $i, 'date')) .'</td>'.
			'<td>'. make_user_link ( db_result($result, $i, 'assigned_to') ) .'</td>'.
			'<td>'. make_user_link ( db_result($result, $i, 'submitted_by') ) .'</td></tr>';
		}

		/*
			Show extra rows for <-- Prev / Next -->
		*/
		if (($offset > 0) || ($rows >= 50)) {
			echo '
				<tr><td colspan="2">';
			if ($offset > 0) {
				echo '<a href="'.$PHP_SELF.'?func=browse&group_id='.$group_id.'&atid='.$this->getID().'&set='.$set.'&offset='.($offset-50).'"><strong><-- Previous 50</strong></a>';
			} else {
				echo '&nbsp;';
			}
			echo '</td><td>&nbsp;</td><td colspan="2">';
	
			if ($rows >= 50) {
				echo '<a href="'.$PHP_SELF.'?func=browse&group_id='.$group_id.'&atid='.$this->getID().'&set='.$set.'&offset='.($offset+50).'"><strong>Next 50 --></strong></a>';
			} else {
				echo '&nbsp;';
			}
			echo '</td></tr>';
		}

		echo $GLOBALS['HTML']->listTableBottom();
		/*
			Mass Update Code
		*/
		if ($IS_ADMIN) {
			echo '<script language="JavaScript">
	<!-- 
	function checkAll(val) {
		al=document.artifactList;
		len = al.elements.length;
		var i=0;
		for( i=0 ; i<len ; i++) {
			if (al.elements[i].name==\'artifact_id_list[]\') {
				al.elements[i].checked=val;
			}
		}
	}
	//-->
	</script>

			<table width="100%" border="0">
			<tr><td colspan="2">
<font size=1>
<a href="javascript:checkAll(1)">Check&nbsp;All</a>
-
 <a href="javascript:checkAll(0)">Clear&nbsp;All</a>
</font>
<p>
<FONT COLOR="#FF0000"><strong>Admin:</strong></FONT>  If you wish to apply changes to all items selected above, use these controls to change their properties and click once on "Mass Update".
			</td></tr>

			<tr>
			<td><strong>Category: <a href="javascript:help_window(\'/help/tracker.php?helpname=category\')"><strong>(?)</strong></a></strong><br />'. $this->categoryBox ('category_id','xzxz','No Change') .'</td>
			<td><strong>Group: <a href="javascript:help_window(\'/help/tracker.php?helpname=group\')"><strong>(?)</strong></a></strong><br />'. $this->artifactGroupBox ('artifact_group_id','xzxz','No Change') .'</td>
			</tr>

			<tr>
			<td><strong>Priority: <a href="javascript:help_window(\'/help/tracker.php?helpname=priority\')"><strong>(?)</strong></a></strong><br />';
			echo build_priority_select_box ('priority', '100', true);
			echo '</td><td>';
			if ($this->useResolution()) {
				echo '
				<strong>Resolution: <a href="javascript:help_window(\'/help/tracker.php?helpname=resolution\')"><strong>(?)</strong></a></strong><br />';
				echo $this->resolutionBox('resolution_id','xzxz',true,'No Change');
			} else { 
				echo '&nbsp;
				<input type="hidden" name="resolution_id" value="100">';
			}

			echo '</td>
			</tr>

			<tr>
			<td><strong>Assigned To: <a href="javascript:help_window(\'/help/tracker.php?helpname=assignee\')"><strong>(?)</strong></a></strong><br />'. $this->technicianBox ('assigned_to','xzxz',true,'No Change') .'</td>
			<td><strong>Status: <a href="javascript:help_window(\'/help/tracker.php?helpname=status\')"><strong>(?)</strong></a></strong><br />'. $this->statusBox ('status_id','xzxz',true,'No Change') .'</td>
			</tr>

			<tr><td colspan="2"><strong>Canned Response: <a href="javascript:help_window(\'/help/tracker.php?helpname=canned_response\')"><strong>(?)</strong></a></strong><br />'. $this->cannedResponseBox ('canned_response') .'</td></tr>

			<tr><td colspan="3" align="MIDDLE"><input type="SUBMIT" name="submit" value="Mass Update"></td></tr>

			</TABLE>		
		</form>';
		}


	}

}

?>
