#!/usr/bin/make -f
# debian/rules that uses debhelper.
# GNU copyright 1997 to 1999 by Joey Hess (sample file)
# Copyright 2000 to 2002 by Roland Mas and Christian Bayle for the Sourceforge package

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

# This is the debhelper compatability version to use.
export DH_COMPAT=4

configure: configure-stamp
configure-stamp:
	dh_testdir

	touch configure-stamp

build: configure-stamp build-stamp
build-stamp:
	dh_testdir

	# The only things that need to be built are man pages
	/usr/bin/docbook-to-man debian/cvssh.sgml > cvssh.1
	/usr/bin/docbook-to-man debian/sourceforge-config.sgml > sourceforge-config.1

	touch build-stamp

clean:
	dh_testdir
	dh_testroot
	rm -f build-stamp configure-stamp
	rm -f cvssh.1 sourceforge-config.1

	$(CURDIR)/deb-specific/dsf-helper.pl --clean

	dh_clean

install: build
	dh_testdir
	dh_testroot
	dh_clean -k
	dh_installdirs

	# Preprocess files with DSF-Helper
	$(CURDIR)/deb-specific/dsf-helper.pl

	# sourceforge
	# (sourceforge is a meta-package and needs no files)

	# sourceforge-common
	install -m 644 deb-specific/common-utils.sh $(CURDIR)/debian/sourceforge-common/usr/lib/sourceforge/lib/
	install -m 644 deb-specific/local.inc.template $(CURDIR)/debian/sourceforge-common/etc/sourceforge/templates/
	install -m 644 deb-specific/local.pl.template $(CURDIR)/debian/sourceforge-common/etc/sourceforge/templates/
	install -m 644 deb-specific/database.inc.template $(CURDIR)/debian/sourceforge-common/etc/sourceforge/templates/
	install -m 644 deb-specific/sf-httpd.conf.template $(CURDIR)/debian/sourceforge-common/etc/sourceforge/templates/
	install -m 644 deb-specific/sf-httpd.secrets.template $(CURDIR)/debian/sourceforge-common/etc/sourceforge/templates/
	install -m 755 deb-specific/install-chroot.sh $(CURDIR)/debian/sourceforge-common/usr/lib/sourceforge/bin/
	install -m 755 deb-specific/fill-in-the-blanks.pl $(CURDIR)/debian/sourceforge-common/usr/lib/sourceforge/bin/
	install -m 755 deb-specific/sourceforge-config $(CURDIR)/debian/sourceforge-common/usr/sbin/
	install -m 644 utils/include.pl $(CURDIR)/debian/sourceforge-common/usr/lib/sourceforge/lib/
	install utils/underworld-dummy/ssh_dump.pl $(CURDIR)/debian/sourceforge-common/usr/lib/sourceforge/bin/
	install utils/ssh_create.pl $(CURDIR)/debian/sourceforge-common/usr/lib/sourceforge/bin/
	install -m 755 deb-specific/install-ssh.sh $(CURDIR)/debian/sourceforge-common/usr/lib/sourceforge/bin/
	install utils/underworld-dummy/dump_database.pl $(CURDIR)/debian/sourceforge-common/usr/lib/sourceforge/bin/
	install utils/new_parse.pl $(CURDIR)/debian/sourceforge-common/usr/lib/sourceforge/bin/
	install -m 4755 deb-specific/fileforge.pl $(CURDIR)/debian/sourceforge-common/usr/lib/sourceforge/bin/
	ln -sf fileforge.pl $(CURDIR)/debian/sourceforge-common/usr/lib/sourceforge/bin/tmpfilemove.pl
	install -m 755 deb-specific/update-user-group-cvs.sh $(CURDIR)/debian/sourceforge-common/usr/lib/sourceforge/bin/

	# sourceforge-web-apache
	cp -r www $(CURDIR)/debian/sourceforge-web-apache/usr/lib/sourceforge/
	cp -r common $(CURDIR)/debian/sourceforge-web-apache/usr/lib/sourceforge/
	find $(CURDIR)/debian/sourceforge-web-apache/usr/lib/sourceforge/ -name CVS -type d | xargs rm -rf
	find $(CURDIR)/debian/sourceforge-web-apache/usr/lib/sourceforge/www -type d -exec chmod 0755 {} \;
	find $(CURDIR)/debian/sourceforge-web-apache/usr/lib/sourceforge/www -type f -exec chmod 0644 {} \;
	find $(CURDIR)/debian/sourceforge-web-apache/usr/lib/sourceforge/common -type d -exec chmod 0755 {} \;
	find $(CURDIR)/debian/sourceforge-web-apache/usr/lib/sourceforge/common -type f -exec chmod 0644 {} \;
	install -o www-data -m 755 -d $(CURDIR)/debian/sourceforge-web-apache/var/cache/sourceforge
	uudecode -o $(CURDIR)/debian/sourceforge-web-apache/usr/lib/sourceforge/www/images/sf-for-debian.png deb-specific/sf-for-debian.png.uu
	uudecode -o $(CURDIR)/debian/sourceforge-web-apache/usr/lib/sourceforge/www/images/clear.png deb-specific/clear.png.uu
	uudecode -o $(CURDIR)/debian/sourceforge-web-apache/usr/lib/sourceforge/www/images/debian-sf-icon.png deb-specific/debian-sf-icon.png.uu
	install -m 755 deb-specific/install-apache.sh $(CURDIR)/debian/sourceforge-web-apache/usr/lib/sourceforge/bin/

	# sourceforge-db-postgresql
	install -m 644 db/SourceForge.sql $(CURDIR)/debian/sourceforge-db-postgresql/usr/lib/sourceforge/db/
	#install -m 644 db/trove_defaults.sql $(CURDIR)/debian/sourceforge-db-postgresql/usr/lib/sourceforge/db/
	install -m 644 db/user_rating.sql $(CURDIR)/debian/sourceforge-db-postgresql/usr/lib/sourceforge/db/
	install -m 644 deb-specific/sf-2.6-complete.sql $(CURDIR)/debian/sourceforge-db-postgresql/usr/lib/sourceforge/db/
	install -m 644 deb-specific/sf2.5-to-sf2.6.sql $(CURDIR)/debian/sourceforge-db-postgresql/usr/lib/sourceforge/db/
	install -m 755 cronjobs/db_trove_maint.php $(CURDIR)/debian/sourceforge-db-postgresql/usr/lib/sourceforge/bin/
	install -m 755 cronjobs/project_cleanup.php $(CURDIR)/debian/sourceforge-db-postgresql/usr/lib/sourceforge/bin/
	#install -m 755 cronjobs/project_metric.php $(CURDIR)/debian/sourceforge-db-postgresql/usr/lib/sourceforge/bin/
	install -m 755 cronjobs/project_weekly_metric.php $(CURDIR)/debian/sourceforge-db-postgresql/usr/lib/sourceforge/bin/
	install -m 755 cronjobs/rating_stats.php $(CURDIR)/debian/sourceforge-db-postgresql/usr/lib/sourceforge/bin/
	install -m 755 cronjobs/site_stats.php $(CURDIR)/debian/sourceforge-db-postgresql/usr/lib/sourceforge/bin/
	install -m 755 cronjobs/populate_foundries.php $(CURDIR)/debian/sourceforge-db-postgresql/usr/lib/sourceforge/bin/
	install -m 755 cronjobs/calculate_user_metric.php $(CURDIR)/debian/sourceforge-db-postgresql/usr/lib/sourceforge/bin/
	install -m 755 cronjobs/vacuum.php $(CURDIR)/debian/sourceforge-db-postgresql/usr/lib/sourceforge/bin/
	install -m 755 cronjobs/rotate_activity.php $(CURDIR)/debian/sourceforge-db-postgresql/usr/lib/sourceforge/bin/
	#install utils/underworld-root/db_top_groups_calc.pl $(CURDIR)/debian/sourceforge-db-postgresql/usr/lib/sourceforge/bin/db_top_groups_calc.pl
	#install utils/underworld-root/stats_nightly.sh $(CURDIR)/debian/sourceforge-db-postgresql/usr/lib/sourceforge/bin/stats_nightly.sh
	#install utils/underworld-root/db_stats_prepare.pl $(CURDIR)/debian/sourceforge-db-postgresql/usr/lib/sourceforge/bin/db_stats_prepare.pl
	#install utils/underworld-root/db_stats_projects_nightly.pl $(CURDIR)/debian/sourceforge-db-postgresql/usr/lib/sourceforge/bin/db_stats_projects_nightly.pl
	#install utils/underworld-root/db_stats_site_nightly.pl $(CURDIR)/debian/sourceforge-db-postgresql/usr/lib/sourceforge/bin/db_stats_site_nightly.pl
	install -m 755 deb-specific/install-db.sh $(CURDIR)/debian/sourceforge-db-postgresql/usr/lib/sourceforge/bin/
	install -m 755 deb-specific/db-upgrade.pl $(CURDIR)/debian/sourceforge-db-postgresql/usr/lib/sourceforge/bin/
	install -m 755 deb-specific/sqlparser.pm $(CURDIR)/debian/sourceforge-db-postgresql/usr/lib/sourceforge/lib/
	install -m 755 deb-specific/sf-add-skill $(CURDIR)/debian/sourceforge-db-postgresql/usr/lib/sourceforge/bin/
	install -m 755 deb-specific/sf-register-theme $(CURDIR)/debian/sourceforge-db-postgresql/usr/lib/sourceforge/bin/

	# sourceforge-mta-exim
	install -m 755 deb-specific/install-exim.sh $(CURDIR)/debian/sourceforge-mta-exim/usr/lib/sourceforge/bin/

	# sourceforge-shell-ldap

	# sourceforge-cvs
	install -m 755 deb-specific/stats_cvs.pl $(CURDIR)/debian/sourceforge-cvs/usr/lib/sourceforge/bin/
	install -m 755 deb-specific/install-cvs.sh $(CURDIR)/debian/sourceforge-cvs/usr/lib/sourceforge/bin/
	install -m 755 deb-specific/cvs-pserver $(CURDIR)/debian/sourceforge-cvs/usr/lib/sourceforge/bin/
	install -m 755 deb-specific/cvssh.pl $(CURDIR)/debian/sourceforge-cvs/bin/cvssh 
	install -m 755 deb-specific/cvsweb/cvsweb.cgi $(CURDIR)/debian/sourceforge-cvs/usr/lib/sourceforge/cgi-bin/
	uudecode -o $(CURDIR)/debian/sourceforge-cvs/usr/lib/sourceforge/cvs/icons/back.png deb-specific/cvsweb/icons/back.png.uu
	uudecode -o $(CURDIR)/debian/sourceforge-cvs/usr/lib/sourceforge/cvs/icons/dir.png deb-specific/cvsweb/icons/dir.png.uu
	uudecode -o $(CURDIR)/debian/sourceforge-cvs/usr/lib/sourceforge/cvs/icons/minidir.png deb-specific/cvsweb/icons/minidir.png.uu
	uudecode -o $(CURDIR)/debian/sourceforge-cvs/usr/lib/sourceforge/cvs/icons/text.png deb-specific/cvsweb/icons/text.png.uu
	uudecode -o $(CURDIR)/debian/sourceforge-cvs/usr/lib/sourceforge/cvs/icons/miniback.png deb-specific/cvsweb/icons/miniback.png.uu
	uudecode -o $(CURDIR)/debian/sourceforge-cvs/usr/lib/sourceforge/cvs/icons/minitext.png deb-specific/cvsweb/icons/minitext.png.uu
	install -m 644 deb-specific/cvsweb/cvsweb.conf $(CURDIR)/debian/sourceforge-cvs/etc/sourceforge/
	install -m 755 deb-specific/tarballs.sh $(CURDIR)/debian/sourceforge-cvs/usr/lib/sourceforge/bin/

	# sourceforge-ftp-proftpd
	install -m 755 deb-specific/install-ftp.sh $(CURDIR)/debian/sourceforge-ftp-proftpd/usr/lib/sourceforge/bin/
	install -m 644 deb-specific/sf-proftpd.conf $(CURDIR)/debian/sourceforge-ftp-proftpd/etc/sourceforge/

	# sourceforge-ldap-openldap
	install -m 755 utils/sql2ldif.pl $(CURDIR)/debian/sourceforge-ldap-openldap/usr/lib/sourceforge/bin/
	install -m 755 deb-specific/install-ldap.sh $(CURDIR)/debian/sourceforge-ldap-openldap/usr/lib/sourceforge/bin/
	install -m 644 deb-specific/sourceforge.schema $(CURDIR)/debian/sourceforge-ldap-openldap/etc/sourceforge/

	# sourceforge-dns-bind9
	install -m 755 deb-specific/install-dns.sh $(CURDIR)/debian/sourceforge-dns-bind9/usr/lib/sourceforge/bin/
	install -m 644 deb-specific/dns.head.template $(CURDIR)/debian/sourceforge-dns-bind9/var/lib/sourceforge/bind/
	install -m 644 deb-specific/dns.simple.template $(CURDIR)/debian/sourceforge-dns-bind9/var/lib/sourceforge/bind/
	install utils/underworld-dummy/dns_conf.pl $(CURDIR)/debian/sourceforge-dns-bind9/usr/lib/sourceforge/bin/

	# sourceforge-lists-mailman
	install -m 755 deb-specific/create-mailing-lists.pl $(CURDIR)/debian/sourceforge-lists-mailman/usr/lib/sourceforge/bin/

binary-indep: build install
	dh_testdir
	dh_testroot
	dh_installdebconf	
	dh_installdocs
	#dh_installexamples
	#dh_installmenu
	#dh_installemacsen
	#dh_installpam
	#dh_installinit
	dh_installcron
	dh_installman -p sourceforge-common
	#dh_installinfo
	#dh_undocumented
	dh_installchangelogs ChangeLog
	#dh_link
	dh_strip
	dh_compress
	#dh_fixperms
	#dh_makeshlibs
	dh_installdeb
	#dh_perl
	#dh_shlibdeps
	dh_gencontrol
	dh_md5sums
	dh_builddeb

binary-arch: build install
	# (No architecture-dependent files for Sourceforge)

binary: binary-indep binary-arch
.PHONY: build clean binary-indep binary-arch binary install configure
