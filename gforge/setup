#! /bin/sh
apacheconf=/etc/apache/httpd.conf

usage() {
	echo "$0: [-interact] [-help] [-debug] [-input conffile] [-output conffile] [-example] [-clean]"
}

CONFFILEIN=etc/gforge.conf
CONFFILEOUT=etc/gforge.conf
LOCALINC=etc/local.inc
HTTPDCONF=etc/httpd.conf

while [ $# -ne 0 ]
do
	case "$1" in
		-interact )
			interact=true
			shift
			;;
		-help )
			usage
			exit 0
			;;
		-input )
			shift
			CONFFILEIN=$1
			;;
		-output )
			shift
			CONFFILEOUT=$1
			;;
		-example )
			CONFFILEIN=etc/gforge.conf.example
			CONFFILEOUT=etc/gforge.conf.example
			LOCALINC=etc/local.inc.example
			HTTPDCONF=etc/httpd.conf.example
			;;
		-clean )
			rm -f $HTTPDCONF
			rm -f etc/httpd.secrets
			rm -f $LOCALINC
			rm -f $CONFFILEIN
			exit 0
			;;
		-debug )
			set -x
			;;
		*)
			echo "Bad Parameter"
			usage
			;;
	esac
	shift
done

getval(){
	echo -n $1 \[$2\] ?
	read $1
}

# This is used to make a default working gforge.conf
computedefault(){
DEFAULTsystem_name=Gforge
DEFAULTdomain_name=`hostname -f`
DEFAULTserver_admin=webmaster@$DEFAULTdomain_name
DEFAULTdb_host=`hostname -i`
DEFAULTdb_name=gforge
DEFAULTdb_user=gforge
DEFAULTdb_password=$(dd if=/dev/urandom count=256 bs=1 2> /dev/null | md5sum | cut -b1-8)
DEFAULTip_address=`hostname -i`
DEFAULTcvs_host=cvs.$DEFAULTdomain_name
DEFAULTshell_host=shell.$DEFAULTdomain_name
DEFAULTusers_host=users.$DEFAULTdomain_name
DEFAULTlists_host=lists.$DEFAULTdomain_name
DEFAULTdocs_host=gfdocs.$DEFAULTdomain_name
DEFAULTjabber_host=jabber.$DEFAULTdomain_name
DEFAULTdownload_host=download.$DEFAULTdomain_name
DEFAULTupload_host=upload.$DEFAULTdomain_name
DEFAULTstatsadmin_groupid=2
DEFAULTnewsadmin_groupid=3
DEFAULTpeerrating_groupid=4
DEFAULTadmin_login=admin
DEFAULTadmin_password=$(dd if=/dev/urandom count=256 bs=1 2> /dev/null | md5sum | cut -b1-8)
DEFAULTskill_list="Ada;C;C++;HTML;LISP;Perl;PHP;Python;SQL"
DEFAULTdefault_trove_cat=18
DEFAULTldap_host=localhost
DEFAULTldap_base_dn="dc=`echo $DEFAULTdomain_name | sed 's/\./,dc=/g'`"
DEFAULTldap_web_add_password=$(dd if=/dev/urandom count=256 bs=1 2> /dev/null | md5sum | cut -b1-8)
DEFAULTcgidir=`pwd`/utils
DEFAULTcronolog_path=`type cronolog | cut -d' ' -f3`
DEFAULTsys_path_to_jpgraph=/usr/share/jpgraph/
DEFAULTsys_path_to_cvsweb=/usr/lib/gforge/bin/
DEFAULTgforge_chroot=""
DEFAULTgforge_etc=`pwd`/etc
DEFAULTgroupdir=`pwd`/home/groups
DEFAULThomedir=`pwd`/home
DEFAULTuploaddir=`pwd`/var/lib/gforge/download/
DEFAULTsys_jabber_pass=$(dd if=/dev/urandom count=256 bs=1 2> /dev/null | md5sum | cut -b1-8)
DEFAULTusr_share_gforge=`pwd`
DEFAULTvar_lib_gforge=`pwd`/var/lib
DEFAULTvar_log_gforge=`pwd`/var/log
DEFAULTsys_show_source=0
DEFAULTsys_force_login=0
DEFAULTsys_session_key=$(dd if=/dev/urandom count=256 bs=1 2> /dev/null | md5sum | cut -b1-32)
DEFAULTsys_theme=gforge
DEFAULTsys_lang=English
DEFAULTsys_use_ldap=0
DEFAULTsys_use_jabber=0
DEFAULTsys_use_auth_ldap=1
DEFAULTsys_ldap_auth_host=localhost
DEFAULTsys_ldap_auth_port=389
DEFAULTsys_ldap_auth_version=3
DEFAULTsys_ldap_auth_dn="dc=`echo $DEFAULTdomain_name | sed 's/\./,dc=/g'`"
DEFAULTsys_use_cvs=true
DEFAULTsys_use_tracker=true
DEFAULTsys_use_forum=true
DEFAULTsys_use_pm=true
DEFAULTsys_use_docman=true
DEFAULTsys_use_news=true
DEFAULTsys_use_mail=true
DEFAULTsys_use_survey=true
DEFAULTsys_use_file=true
DEFAULTsys_use_ftp=true
DEFAULTsys_use_trove=true
DEFAULTsys_use_snippet=true
DEFAULTsys_project_reg_restricted=true
DEFAULTsys_localization_enable_caching=true
DEFAULTsys_localization_cache_path=/var/cache/gforge/
DEFAULTsys_localization_enable_timestamp_checking=true

# TODO
#usr_lib_gforge=`pwd`
#vhost_name
#docdir
}

writedefault(){
# Here is the fun
# This create a default conf file in $1 
tmpfile=$1.$$computedefault
echo "cat >$1<<-EOF" > $tmpfile
cat $0 | grep ^DEFAULT | sed 's/DEFAULT\(.[^=]*\)=.*/\1=\${DEFAULT\1}/' >> $tmpfile
echo 'EOF' >> $tmpfile
. $tmpfile
rm -f $tmpfile
}

readdefault() {
	cat $1 | sed 's/\(.[^=]*\)=\(.*\)/DEFAULT\1="\2"/' > $1.$$readdefault
	. $1.$$readdefault
	rm -f $1.$$readdefault
}

echo "Setting defaults"

computedefault
writedefault etc/gforge.conf.new
if [ -f $CONFFILEIN ]
then
	readdefault $CONFFILEIN
	echo "Red default from $CONFFILEIN"
else
	readdefault etc/gforge.conf.new
fi

if [ "$interact" == true ]
then
	echo "Enter values or type enter for defaults:"
	# Here is the fun II
	# This ask for change of default
	tmpfile=$1.$$getval
	cat $0 | grep ^DEFAULT | sed 's/DEFAULT\(.[^=]*\)=.*/getval \1 "\${DEFAULT\1}"/' > $tmpfile
else
	cat $0 | grep ^DEFAULT | sed 's/DEFAULT\(.[^=]*\)=.*/\1="\${DEFAULT\1}"/' > $tmpfile
fi
. $tmpfile
rm -f $tmpfile

writedefault etc/gforge.conf.new
mv etc/gforge.conf.new $CONFFILEOUT
#cat $0 | grep '^DEFAULT' | sed 's/^DEFAULT\(.[^=]*\)=.*/DEFAULT\1 \1/' | while read defvar var
#do
#	echo $defvar $var 
#done


# Remove trailing space
cat $CONFFILEIN | sed 's/ *$//' > etc/gforge.conf.new
mv etc/gforge.conf.new $CONFFILEIN

echo "Create $HTTPDCONF and etc/httpd.secrets"
for i in etc/httpd.d/[0-4][0-9]* etc/httpd.d/httpd.secrets
do
	utils/fill-in-the-blanks.pl $i etc/`basename $i` $CONFFILEOUT
done
ls etc/[0-9][0-9]* | sort | xargs cat > $HTTPDCONF
rm etc/[0-9][0-9]*

echo "Create $LOCALINC"
for i in etc/local.d/01* etc/local.d/10*simple etc/local.d/[2-9]*
do
	utils/fill-in-the-blanks.pl $i etc/`basename $i` $CONFFILEOUT
done
ls etc/01* etc/10*simple etc/[2-9]* | sort | xargs cat > $LOCALINC
rm etc/01* etc/10*simple etc/[2-9]*


export etcgforge=`pwd`/etc
if [ -f $apacheconf ] ; then
	if ! grep -q "^Include $etcgforge/httpd.conf" $apacheconf ; then
		utils/install-apache.sh setup
	fi
fi
