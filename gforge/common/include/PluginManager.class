<?php
/**
 *	PluginManager object
 *
 *	Provides an abstract way to handle plugins
 *
 * SourceForge: Breaking Down the Barriers to Open Source Development
 * This file is copyright (c) Roland Mas <lolando@debian.org>, 2002
 *
 * $Id$
 *
 */

/**
 *  plugin_manager_get_object() - Get the Plugin Manager object.
 */
function &plugin_manager_get_object() {
	// echo "Entered plugin_manager_get_object " ;
	global $PLUGINMANAGER_OBJ;
	if (!isset($PLUGINMANAGER_OBJ)) {
		// echo "Creating object " ;
		$PLUGINMANAGER_OBJ = new PluginManager() ;
	}
	return $PLUGINMANAGER_OBJ ;
}

class PluginManager extends Error {
	var $plugins_objects ;
	var $plugins_to_hooks ;
	var $hooks_to_plugins ;

	function PluginManager () {
		// echo "Entered PluginManager " ;
		$this->Error() ;
		$this->plugins_objects = array () ;
		$this->plugins_to_hooks = array () ;
		$this->hooks_to_plugins = array () ;
	}

	function GetPlugins () {
		if (!isset($this->plugins_data)) {
			$this->plugins_data = array () ;
			$sql = "SELECT * FROM plugins" ;
			$res = db_query($sql);
			$rows = db_numrows($res);

			for ($i=0; $i<$rows; $i++) {
				$plugin_id = db_result($res,$i,'plugin_id');
				$this->plugins_data[$plugin_id] = db_result($res,$i,'plugin_name');
			}
		}
		return $this->plugins_data ;
	}

	function PluginIsInstalled ($pluginname) {
		$plugins_data = $this->getPlugins() ;
		foreach ($plugins_data as $p_id => $p_name) {
			if ($p_name == $pluginname) {
				return true ;
			}
		}
		return false ;
	}

	function RegisterPlugin ($pluginname, $pluginobject) {
		global $PLUGINMANAGER_OBJ ;
		// echo "Registering plugin $pluginname " ;
		$PLUGINMANAGER_OBJ->plugins_objects[$pluginname] = $pluginobject ;
		// echo count($PLUGINMANAGER_OBJ->plugins_objects) . " objects in plugins_objects " ;
		// echo "<br>--- " . serialize($this) . " ---<br>" ;
	}

	function LoadPlugins () {
		// echo "Entered LoadPlugins " ;
		$plugins_data = $this->GetPlugins() ;
		$include_path = "/usr/lib/sourceforge/plugins/" ;
		foreach ($plugins_data as $p_id => $p_name) {
			$filename = $include_path . $p_name . "/include/".$p_name."-init.php" ;
			// echo "Trying $filename " ;
			if (file_exists ($filename)) {
				require_once ($filename) ;
			}
		}
	}

	function SetupHooks () {
		global $PLUGINMANAGER_OBJ ;
		// echo "Entered SetupHooks " ;
		// echo count($this->plugins_objects) . " objects in plugins_objects " ;
		// echo "<br>--- " . serialize($this) . " ---<br>" ;
		$this->plugins_to_hooks = array ();
		foreach ($this->plugins_objects as $p_name => $p_obj) {
			// echo "Reading hooks for plugin $p_name " ;
			$this->plugins_to_hooks [$p_name] = $p_obj->GetHooks () ;
		}
		$this->hooks_to_plugins = array () ;
		foreach ($this->plugins_to_hooks as $p_name => $hook_list) {
			foreach ($hook_list as $hook_name) {
				if (!isset ($this->hooks_to_plugins[$hook_name])) {
					$this->hooks_to_plugins[$hook_name] = array () ;
				}
				$this->hooks_to_plugins[$hook_name][] = $p_name ;
			}
		}
	}

	function Init () {
		// echo "Entered Init " ;
		$this->LoadPlugins () ;
		// echo count($this->plugins_objects) . " objects in plugins_objects " ;
		// echo "<br>--- " . serialize($this) . " ---<br>" ;
		$this->SetupHooks () ;
	}

	function RunHooks ($hookname, $params=false) {
		echo "\n<!-- Starting hook $hookname -->" ;
		$p_list = $this->hooks_to_plugins[$hookname] ;
		if (isset ($p_list)) {
			foreach ($p_list as $p_name) {
				echo "<!-- Hook $hookname for plugin $p_name -->" ;
				$p_obj = $this->plugins_objects[$p_name] ;
				$p_obj->CallHook ($hookname, $params) ;
				echo "<!-- End of hook $hookname for plugin $p_name -->" ;
			}
		}
		echo "<!-- End of hook $hookname -->\n" ;
	}
}

plugin_manager_get_object() ;

$PLUGINMANAGER_OBJ->Init () ;

// Local Variables:
// mode: php
// c-file-style: "bsd"
// End:

?>
