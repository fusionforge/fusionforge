<?php
/**
 * User class
 *
 * Sets up database results and preferences for a user and abstracts this info
 *
 *  You can now optionally pass in a db result
 *  handle. If you do, it re-uses that query
 *  to instantiate the objects
 *
 *  IMPORTANT! That db result must contain all fields
 *  from users table or you will have problems
 *
 * GENERALLY YOU SHOULD NEVER INSTANTIATE THIS OBJECT DIRECTLY
 * USE user_get_object() to instantiate properly - this will pool the objects
 * and increase efficiency
 *
 * SourceForge: Breaking Down the Barriers to Open Source Development
 * Copyright 1999-2001 (c) VA Linux Systems
 * http://sourceforge.net
 *
 * @version   $Id$
 * @author Tim Perdue tperdue@valinux.com
 * @date 2000-10-11
 *
 */

require_once('www/include/vote_function.php');
$USER_OBJ=array();

/**
 * user_get_object_by_name() - Get User object by username.
 *  user_get_object is useful so you can pool user objects/save database queries
 *  You should always use this instead of instantiating the object directly 
 *
 *  @param		string	The unix username - required
 *  @param		int		The result set handle ("SELECT * FROM USERS WHERE user_id=xx")
 *  @return a user object or false on failure
 *
 */
function &user_get_object_by_name($user_name,$res=false) {
	$user_name = strtolower($user_name);
	if (!$res) {
		$res=db_query("SELECT * FROM users WHERE user_name='$user_name'");
	}
	return user_get_object(db_result($res,0,'user_id'),$res);
}

/**
 * user_get_object() - Get User object by user ID.
 *  user_get_object is useful so you can pool user objects/save database queries
 *  You should always use this instead of instantiating the object directly 
 *
 *  @param		int		The ID of the user - required
 *  @param		int		The result set handle ("SELECT * FROM USERS WHERE user_id=xx")
 *  @return a user object or false on failure
 *
 */
function &user_get_object($user_id,$res=false) {
	//create a common set of group objects
	//saves a little wear on the database
	
	//automatically checks group_type and 
	//returns appropriate object
	
	global $USER_OBJ;
	if (!isset($USER_OBJ["_".$user_id."_"])) {
		if ($res) {
			//the db result handle was passed in
		} else {
			$res=db_query("SELECT * FROM users WHERE user_id='$user_id'");
		}
		if (!$res || db_numrows($res) < 1) {
			$USER_OBJ["_".$user_id."_"]=false;
		} else {
			$USER_OBJ["_".$user_id."_"]= new User($user_id,$res);
		}
	}
	return $USER_OBJ["_".$user_id."_"];
}

class User extends Error {
	/** 
	 * Associative array of data from db
	 *
	 * @var		array	$data_array
	 */
	var $data_array;
	
	/**
	 * The User ID
	 *
	 * @var		int		$user_id
	 */
	var $user_id;
	
	/**
	 * Database result set handle
	 *
	 * @var		int		$db_result
	 */
	var $db_result;

	/**
	 * Is this person a site super-admin?
	 *
	 * @var		bool	$is_super_user
	 */
	var $is_super_user;

	/**
	 * Is this person the logged in user?
	 *
	 * @var		bool	$is_logged_in
	 */
	var $is_logged_in;

	/**
	 * Array of preferences
	 *
	 * @var		array	$user_pref
	 */
	var $user_pref;

	/**
	 *	User($id,$res) - CONSTRUCTOR - GENERALLY DON'T USE THIS
	 *
	 *	instead use the user_get_object() function call
	 *
	 *	@param	int		The user_id
	 *	@param	int		The database result set
	 */
	function User($id=false,$res=false) {
		$this->Error();
		if (!$id) {
			//setting up an empty object
			//probably going to call create()
			return true;
		}
		$this->user_id=$id;
		if (!$res) {
			$this->db_result=db_query("SELECT * FROM users WHERE user_id='$id'");
		} else {
			$this->db_result=$res;
		}
		if (db_numrows($this->db_result) < 1) {
			//function in class we extended
			$this->setError('User Not Found');
			$this->data_array=array();
			return false;
		} else {
			//set up an associative array for use by other functions
			
			db_reset_result($this->db_result);
			
			$this->data_array =& db_fetch_array($this->db_result);
		}
		$this->user_id=$this->data_array['user_id'];
		$this->is_super_user=false;
		$this->is_logged_in=false;
		return true;
	}
	
	/**
	 * create() - Create a new user
	 *
	 * @param	string	The unix username 
	 * @param	string	The real username
	 * @param	string	The first password 
	 * @param	string	The confirmation password 
	 * @param	string	The users email address
	 * @param	string	The users preferred default language
	 * @param	string	The users preferred default timezone
	 * @param	string	The users preference for receiving site updates by email
	 * @param	string	The users preference for receiving community updates by email
	 * @param	int		The ID of the language preference
	 * @param	string	The users preferred timezone
	 * @returns The newly created user ID
	 *
	 */
	function create($unix_name,$realname,$password1,$password2,$email,
		$mail_site,$mail_va,$language_id,$timezone) {
		global $Language;
		if (!$unix_name) {
			//$this->setError('You must supply a username');
			$this->setError($Language->getText('account_register','err_username'));
			return false;
		}
		if (!$realname) {
			//$this->setError('You must supply a real name');
			$this->setError($Language->getText('account_register','err_realname'));
			return false;
		}
		if (!$password1) {
			//$this->setError('You must supply a password');
			$this->setError($Language->getText('account_register','err_passwd'));
			return false;
		}
		if ($password1 != $password2) {
			//$this->setError('Passwords do not match');
			$this->setError($Language->getText('account_register','err_passwd2'));
			return false;
		}
		if (!account_pwvalid($password1)) {
			//$this->setError('Password must be at least 6 characters');
			$this->setError($Language->getText('account_register','err_passwd3'));
			return false;
		}
		$unix_name=strtolower($unix_name);
		if (!account_namevalid($unix_name)) {
			//$this->setError('Invalid Unix Name. ');
			$this->setError($Language->getText('account_register','err_unixname'));
			return false;
		}
		if (!validate_email($email)) {
			//$this->setError('Invalid Email Address');
			$this->setError($Language->getText('account_register','err_email'));
			return false;
		}
		if (db_numrows(db_query("SELECT user_id FROM users WHERE user_name LIKE '$unix_name'")) > 0) {
			//$this->setError('That username already exists.');
			$this->setError($Language->getText('account_register','err_userexist'));
			return false;
		}
		if ($GLOBALS['sys_require_unique_email']) {
			if (db_numrows(db_query("SELECT user_id FROM users WHERE email='$email'")) > 0) {
				//$this->setError('User with this email already exists - use people search to recover your login.');
				$this->setError($Language->getText('account_register','err_mailexist'));
				return false;
			}
		}
		// if we got this far, it must be good
		$confirm_hash = substr(md5($session_hash . $password1 . time()),0,16);
		$result=db_query("INSERT INTO users (user_name,user_pw,unix_pw,realname,email,add_date,
			status,confirm_hash,mail_siteupdates,mail_va,language,timezone) 
			VALUES ('$unix_name',
			'". md5($password1) . "',
			'". account_genunixpw($password1) . "',
			'". "$realname',
			'$email',
			'" . time() . "',
			'P',
			'$confirm_hash',
			'". (($mail_site)?"1":"0") . "',
			'". (($mail_va)?"1":"0") . "',
			'$language_id',
			'$timezone')");

		$this->user_id = db_insertid($result,'users','user_id');
	
		if (!$result || !$this->user_id) {
			//$this->setError('Insert Failed '.db_error());
			$this->setError($Language->getText('account_register','err_badinsert') .db_error());
			return false;
		} else {

			// send mail
			$this->refreshUserData();

			$this->sendRegistrationEmail();

			return $this->user_id;
		}
	}

	/**
	 *	sendRegistrationEmail() - Send email for registration verification
	 *
	 *	@return true or false
	 */
	function sendRegistrationEmail() {
		global $Language;
/*		
		$message = "Thank you for registering on the SourceForge web site. You have\n"
		. "account with username '".$this->getUnixName()."' created for you. In order\n"
		. "to complete your registration, visit the following url: \n\n"
		. "<https://". $GLOBALS['sys_default_domain'] ."/account/verify.php?confirm_hash=_".$this->getConfirmHash().">\n\n"
		. "(If you don't see any URL above, it is likely due to bug in your mail client.\n"
		. "Use one below, but make sure it is entered as the single line.)\n\n"
		. "https://". $GLOBALS['sys_default_domain']."/account/verify.php?confirm_hash=_".$this->getConfirmHash()."\n\n"
		. "Enjoy the site.\n\n"
		. " -- the SourceForge staff\n";
*/
		$link1="<https://". $GLOBALS['sys_default_domain'] ."/account/verify.php?confirm_hash=_".$this->getConfirmHash().">";
		$link2="https://". $GLOBALS['sys_default_domain']."/account/verify.php?confirm_hash=_".$this->getConfirmHash();
		$message=stripcslashes($Language->getText('account_register','message_body',array($this->getUnixName(),$link1,$link2)));
		util_send_mail(
			$this->getEmail(),
			$Language->getText('account_register','message_header'),
			$message
		);
	}

	/**
	 *	update() - update *common* properties of User object
	 *
	 *	Use specific setter to change other properties
	 *
	 *  @param	string	The users real name
	 *  @param	int		The ID of the users language preference
	 *  @param	string	The useres timezone preference
	 *  @param	string	The users preference for receiving site updates by email
	 *  @param	string	The users preference for receiving community updates by email
	 */
	function update($realname,$language_id,$timezone,$mail_site,$mail_va,$use_ratings) {
		$mail_site = $mail_site ? 1 : 0;
		$mail_va   = $mail_va   ? 1 : 0;
		$block_ratings = !$use_ratings;

		$res = db_query("
			UPDATE users
			SET
			realname='$realname',
			language='$language_id',
			timezone='$timezone',
			mail_siteupdates=$mail_site,
			mail_va=$mail_va,
			block_ratings='$block_ratings'
			WHERE user_id='".$this->getID()."'
		");

		if (!$res) {
			$this->setError('ERROR - Could Not Update User Object: '.db_error());
			return false;
		} else {
			// If there's a transaction from using to not
			// using ratings, remove all rating made by the
			// user (ratings by others should not be removed,
			// as it opens possibility to abuse rate system)
			if (!$use_ratings && $this->usesRatings()) {
				vote_remove_all_ratings_by($this->getID());
			}
			$this->refreshUserData();
			return true;
		}
	}

	/**
	 *	getData() - Return database result handle for direct access
	 *
	 *	Generally should NOT be used - here for supporting deprecated group.php
	 *	@return database result set handle
	 */
	function getData() {
		db_reset_result($this->db_result);
		return $this->db_result;
	}

	/**
	 *	refreshUserData() - May need to refresh database fields
	 *
	 *	if an update occurred and you need to access the updated info
	 */
	function refreshUserData() {
		$this->db_result=db_query("SELECT * FROM users WHERE user_id='". $this->getID() ."'");
		$this->data_array=db_fetch_array($this->db_result);
		return $this->db_result;
	}
	
	/**
	 *	getID() - Simply return the user_id for this object
	 *
	 *	@return this user's user_id number
	 */
	function getID() {
		return $this->user_id;
	}

	/**
	 *	getStatus()
	 *
	 *	Statuses include (A)ctive, (P)ending, (S)uspended ,(D)eleted
	 *
	 *	@return this user's status flag
	 */
	function getStatus() {
		return $this->data_array['status'];
	}

	/**
	 *	setStatus()
	 *
	 *	@param	string	Status - P, A, S, or D
	 *	@sets user status
	 */
	function setStatus($status) {

		if ($status != 'P' && $status != 'A'
		    && $status != 'S' && $status != 'D') {
			$this->setError('ERROR: Invalid status value');
			return false;
		}

		db_begin();
		$res=db_query("
			UPDATE users 
			SET status='$status' 
			WHERE user_id='". $this->getID()."'
		");

		if (!$res) {
			$this->setError('ERROR - Could Not Update User Status: '.db_error());
			db_rollback();
			return false;
		} else {
			$this->data_array['status']=$status;
			if ($status == 'D') {
				// Remove this user from all groups
				$res = db_query("
					DELETE FROM user_group
					WHERE user_id='".$this->getID()."'
				");
				if (!$res) {
					$this->setError('ERROR - Could Not Propogate Deleted Status: '.db_error());
					db_rollback();
					return false;
				}
			}
			db_commit();
			return true;
		}
	}

	/**
	 *	isActive()
	 *
	 *	Database field status of 'A' returns true
	 *	@return true or false
	 */
	function isActive() {
		if ($this->getStatus()=='A') {
			return true;
		} else {
			return false;
		}
	}

	/**
	 *	getUnixStatus() - Status of activation of unix account
	 *
	 *	@return (N)one, (A)ctive, (S)uspended or (D)eleted
	 */
	function getUnixStatus() {
		return $this->data_array['unix_status'];
	}

	/**
	 *	setUnixStatus() - Sets status of activation of unix account
	 *
	 *  @param	string	The unix tatus
	 *	@return true/false
	 */
	function setUnixStatus($status) {
		db_begin();
		if ($status != 'N') {
			$this->setUpUnixUID () ;
		}

		$res=db_query("
			UPDATE users 
			SET unix_status='$status' 
			WHERE user_id='". $this->getID()."'
		");

		if (!$res) {
			$this->setError('ERROR - Could Not Update User Unix Status: '.db_error());
			db_rollback();
			return false;
		} else {
			if ($status == 'A') {
				if (!sf_ldap_check_create_user($this->getID())) {
					$this->setError(sf_ldap_get_error_msg());
					db_rollback();
					return false;
				}
			} else {
				if (sf_ldap_check_user($this->getID())) {
					if (!sf_ldap_remove_user($this->getID())) {
						$this->setError(sf_ldap_get_error_msg());
						db_rollback();
						return false;
					}
				}
			}
			
			$this->data_array['unix_status']=$status;
			db_commit();
			return true;
		}
	}

	/**
	 *	getUnixName()
	 *
	 *	@return this user's unix/login name
	 */
	function getUnixName() {
		return strtolower($this->data_array['user_name']);
	}

	/**
	 *	getUnixPasswd()
	 *
	 * 	@return this user's unix crypted passwd
	 */
	function getUnixPasswd() {
		return $this->data_array['unix_pw'];
	}

	/**
	 *	getUnixBox()
	 *
	 * 	@return this user's shell login machine
	 */
	function getUnixBox() {
		return $this->data_array['unix_box'];
	}

	/**
	 *	getMD5Passwd()
	 *
	 *	@return this user's MD5-crypted passwd
	 */
	function getMD5Passwd() {
		return $this->data_array['user_pw'];
	}

	/**
	 *	getConfirmHash()
	 *
	 *	@return this user's confirmation hash
	 */
	function getConfirmHash() {
		return $this->data_array['confirm_hash'];
	}

	/**
	 *	getEmail()
	 *
	 *	@return this user's email address
	 */
	function getEmail() {
		return $this->data_array['email'];
	}

	/**
	 *	getNewEmail()
	 *
	 *	getNewEmail is a private operation for email change
	 *
	 *	@return this user's new (not yet confirmed) email address
	 *	@private
	 */
	function getNewEmail() {
		return $this->data_array['email_new'];
	}

	/**
	 *	setEmail()
	 *
	 *  @param	string	The email address
	 *	@sets user's email address
	 */
	function setEmail($email) {
		if (!$email || !validate_email($email)) {
			$this->setError('ERROR: Invalid Email');
			return false;
		}
		$res=db_query("
			UPDATE users 
			SET email='$email' 
			WHERE user_id='". $this->getID()."'
		");

		if (!$res) {
			$this->setError('ERROR - Could Not Update User Email: '.db_error());
			return false;
		} else {
			$this->data_array['email'] = $email;
			return true;
		}
	}

	/**
	 *	setNewEmailAndHash()
	 *
	 *	setNewEmailAndHash is a private operation for email change
	 *
	 *  @param	string	The email address
	 *  @param	string	The emial hash
	 *	@sets record of user's new email address and confirmation hash
	 */
	function setNewEmailAndHash($email, $hash='') {

		if (!$hash) {
			$hash = substr(md5(strval(time()) . strval(mt_rand())), 0, 16);
		}

		if (!$email || !validate_email($email)) {
			$this->setError('ERROR - Invalid Email');
			return false;
		}

		$res=db_query("
			UPDATE users
			SET confirm_hash='$hash',
			email_new='$email'
			WHERE user_id='".$this->getID()."'
		");

		if (!$res) {
			$this->setError('ERROR - Could Not Update User Email And Hash: '.db_error());
			return false;
		} else {
			$this->data_array['email_new']	= $email;
			$this->data_array['confirm_hash'] = $hash;
			return true;
		}
	}

	/**
	 *	getRealName()
	 *
	 *	@return this user's real name
	 */
	function getRealName() {
		return $this->data_array['realname'];
	}

	/**
	 *	getAddDate()
	 *
	 *	@return this user's unix time since account was opened
	 */
	function getAddDate() {
		return $this->data_array['add_date'];
	}

	/**
	 *	getTimeZone()
	 *
	 *	@return this user's timezone setting
	 */
	function getTimeZone() {
		return $this->data_array['timezone'];
	}

	/**
	 *	getShell()
	 *
	 *	@return this user's preferred shell
	 */
	function getShell() {
?><?php
		return $this->data_array['shell'];
	}

	/**
	 *	setShell()
	 *
	 *  @param	string	The users preferred shell
	 *	@sets user's preferred shell
	 */
	function setShell($shell) {
		$shells = file('/etc/shells');
		$shells[count($shells)] = "/bin/cvssh";
		$out_shells = array();
		foreach ($shells as $s) {
			if (substr($s, 0, 1) == '#') {
				continue;
			}
			$out_shells[] = chop($s);
		}
		if (!in_array($shell, $out_shells)) {
			$this->setError('ERROR: Invalid Shell');
			return false;
		}

		db_begin();
		$res=db_query("
			UPDATE users 
			SET shell='$shell' 
			WHERE user_id='". $this->getID()."'
		");

		if (!$res) {
			$this->setError('ERROR - Could Not Update User Unix Shell: '.db_error());
			db_rollback();
			return false;
		} else {
			// Now change LDAP attribute, but only if corresponding
			// entry exists (i.e. if user have shell access)
			if (sf_ldap_check_user($this->getID()))
			{
				if (!sf_ldap_user_set_attribute($this->getID(),"loginShell",$shell)) {
					$this->setError(sf_ldap_get_error_msg());
					db_rollback();
					return false;
				}
			}
			$this->data_array['shell']=$shell;
		}
		db_commit();
		return true;
	}

	/**
	 *	getUnixUid()
	 *
	 *	@return this user's unix_uid
	 */
	function getUnixUID() {
		return $this->data_array['unix_uid'];
	}

	/**
	 *	getLanguage()
	 *
	 *	@return this user's language_id
	 */
	function getLanguage() {
		return $this->data_array['language'];
	}

	/**
	 *	getAuthorizedKeys()
	 *
	 *	@return this user's SSH authorized (public) keys
	 */
	function getAuthorizedKeys() {
		return ereg_replace("###", "\n", $this->data_array['authorized_keys']);
	}

	/**
	 *	setAuthorizedKeys()
	 *
	 *	@param	string	The users public keys
	 *	@sets this user's SSH authorized (public) keys
	 */
	function setAuthorizedKeys($keys) {
		$keys = trim($keys);
		$keys = ereg_replace("(\r\n)|(\n)", "###", $keys);

		$res=db_query("
			UPDATE users 
			SET authorized_keys='$keys'
			WHERE user_id='".$this->getID()."'
		");

		if (!$res) {
			$this->setError('ERROR - Could Not Update User SSH Keys: '.db_error());
			return false;
		} else {
			$this->data_array['authorized_keys']=$keys;
			return true;
		}
	}

	/**
	 *	getAuthorizedKeys()
	 *
	 *	@return this user's SSH authorized (public) keys
	 */
	function getAuthorizedKeys() {
		return ereg_replace("###", "\n", $this->data_array['authorized_keys']);
	}

	/**
	 *	setAuthorizedKeys()
	 *
	 *  @param	string	The users public keys
	 *	@sets this user's SSH authorized (public) keys
	 */
	function setAuthorizedKeys($keys) {
		$keys = trim($keys);
		$keys = ereg_replace("(\r\n)|(\n)", "###", $keys);

		$res=db_query("
			UPDATE users 
			SET authorized_keys='$keys'
			WHERE user_id='".$this->getID()."'
		");

		if (!$res) {
			$this->setError('ERROR - Could Not Update User SSH Keys');
			return false;
		} else {
			$this->data_array['authorized_keys'] = $keys;
			return true;
		}
	}

	/**
	 *	setLoggedIn($val) - Really only used by session code
	 *
	 * 	@param	bool	The session value
	 */
	function setLoggedIn($val=true) {
		$this->is_logged_in=$val;
		if ($val) {
			//if this is the logged in user - 
			//see if they are a super user
			$sql="SELECT * FROM user_group ".
				"WHERE user_id='". $this->getID() ."' AND group_id='1' AND admin_flags='A'";
			$result=db_query($sql);
			if (!$result || db_numrows($result) < 1) {
				$this->is_super_user=false;
			} else {
				$this->is_super_user=true;
			}
		}
	}

	/**
	 *	isLoggedIn()
	 *
	 *	@return true or false
	 */
	function isLoggedIn() {
		return $this->is_logged_in;
	}

	/**
	 *	setPreference($preference_name,$value)
	 *
	 *	@param	string	Tthe unique field name for this preference
	 *	@param	string	The value you are setting this preference to
	 *	@return true or false on failure
	 */
	function setPreference($preference_name,$value) {
		$preference_name=strtolower(trim($preference_name));
		$result=db_query("UPDATE user_preferences SET preference_value='$value',set_date='". time() ."' ".
			"WHERE user_id='". $this->getID() ."' ".
			"AND preference_name='$preference_name'");
		if (db_affected_rows($result) < 1) {
			//echo db_error();
			$result=db_query("INSERT INTO user_preferences (user_id,preference_name,preference_value,set_date) ".
				"VALUES ('". $this->getID() ."','$preference_name','$value','". time() ."')");
			return $result;
		}
	}

	/**
	 *	getPreference($preference_name)
	 *
	 *	@param	string	The unique field name for this preference
	 *	@return the preference or false on failure
	 */
	function getPreference($preference_name) {
		$preference_name=strtolower(trim($preference_name));
		/*
			First check to see if we have already fetched the preferences
		*/
		if ($this->user_pref) {
			//echo "\n\nPrefs were fetched already";
			if ($this->user_pref["$preference_name"]) {
				//we have fetched prefs - return part of array
				return $this->user_pref["$preference_name"];
			} else {
				//we have fetched prefs, but this pref hasn't been set
				return false;
			}
		} else {
			//we haven't returned prefs - go to the db
			$result=db_query("SELECT preference_name,preference_value FROM user_preferences ".
				"WHERE user_id='". $this->getID() ."'");
			if (db_numrows($result) < 1) {
				//echo "\n\nNo Prefs Found";
				return false;
			} else {
				$pref=array();
				//iterate and put the results into an array
				for ($i=0; $i<db_numrows($result); $i++) {
					$pref["".db_result($result,$i,'preference_name').""]=db_result($result,$i,'preference_value');
				}
				$this->user_pref =& $pref;

				if ($this->user_pref["$preference_name"]) {
					//we have fetched prefs - return part of array
					return $this->user_pref["$preference_name"];
				} else {
					//we have fetched prefs, but this pref hasn't been set
					return false;
				}
			}
		}
	}

	/**
	 *	setUpUnixUID() - Sets up this user's unix_uid for shell access
	 *
	 *	@return true on success false on failure
	 */
	function setUpUnixUID() {
		global $sys_database_type;
		if ($this->getUnixUID() > 1) {
			//
			//	already have unix_uid
			//
			return true;
		}
		//get the next unix uid

		/*
			hack to simulate sequences in mysql
		*/
		if ($sys_database_type=='mysql') {
			$res=db_query("INSERT INTO unix_uids (id) values ('')");
			$unixid=db_insertid($res,'unix_uids','id');
			db_free_result($res);
		} else {
			$res=db_query("SELECT nextval('unix_uid_seq')");
			$unixid=db_result($res,0,0);
			db_free_result($res);
		}
		if (!$unixid) {
			$this->setError('ERROR - Could Not Get Next Unix UID');
			return false;
		} else {
			$res=db_query("
				UPDATE users 
				SET unix_status='A',unix_uid='$unixid' 
				WHERE user_id='". $this->getID()."'
			");

			if (!$res || db_affected_rows($res) < 1) {
				$this->setError('ERROR - Could Not Update User Account Flags: '.db_error());
				return false;
			} else {
				$this->data_array['unix_uid'] = $unixid;
				return true;
			}
		}
	}
	
	/**
	 *	setPasswd($passwd) - Changes user's password
	 *
	 *	@param	string	The plaintext password
	 *	@return true on success false on failure
	 */
	function setPasswd($passwd) {
	        if (!account_pwvalid($passwd)) {
	        	$this->setError('Error: '.$GLOBALS['register_error']);
			return false;
	        }

		db_begin();
		$unix_pw = account_genunixpw($passwd);

		$res=db_query("
			UPDATE users
			SET user_pw='" . md5($passwd) . "',
				unix_pw='$unix_pw'
			WHERE user_id='".$this->getID()."'
		");

		if (!$res || db_affected_rows($res) < 1) {
			$this->setError('ERROR - Could Not Change User Password: '.db_error());
			db_rollback();
			return false;
		} else {
			// Now change LDAP password, but only if corresponding
			// entry exists (i.e. if user have shell access)
			if (sf_ldap_check_user($this->getID()))
			{
				if (!sf_ldap_user_set_attribute($this->getID(),"userPassword",'{crypt}'.$unix_pw)) {
					$this->setError(sf_ldap_get_error_msg());
					db_rollback();
					return false;
				}
			}
		}
		db_commit();
		return true;
	}

	/**
	 *	usesRatings() - whether user participates in rating system
	 *
	 *	@return true/false
	 */
	function usesRatings() {
		return !$this->data_array['block_ratings'];
	}

	/**
	 *	getMailingsPrefs($mailing_id) - Get activity status for one of the site mailings
	 *
	 *	@param	string	The id of mailing ('mail_va' for community mailings, 'mail_siteupdates' for site mailings)
	 *	@return true/false
	 */
	function getMailingsPrefs($mailing_id) {
		if ($mailing_id=='va') {
			return $this->data_array['mail_va'];
		} else if ($mailing_id=='site') {
			return $this->data_array['mail_siteupdates'];
		} else {
			return 0;
		}
	}

	/**
	 *	unsubscribeFromMailings($all) - Disable email notifications for user
	 *
	 *	@param	bool	If false, disable general site mailings, else - all
	 *	@return true on success false on failure
	 */
	function unsubscribeFromMailings($all=false) {
		$res1 = $res2 = $res3 = true;
		$res1 = db_query("
			UPDATE users
			SET mail_siteupdates=0,
				mail_va=0
			WHERE user_id='".$this->getID()."'
		");
		if ($all) {
			$res2 = db_query("
				DELETE FROM forum_monitored_forums
				WHERE user_id='".$this->getID()."'
			");
			$res3 = db_query("
				DELETE FROM filemodule_monitor
				WHERE user_id='".$this->getID()."'
			");
		}

		return $res1 && $res2 && $res3;
	}

}

/*




		EVERYTHING BELOW HERE IS DEPRECATED


		DO NOT USE FOR ANY NEW CODE



*/



/**
 * user_ismember() - DEPRECATED; DO NOT USE!
 *
 * @param		int		The Group ID
 * @param		int		The Type
 * @deprecated
 *
 */
function user_ismember($group_id,$type=0) {
	if (!user_isloggedin()) {
		return false;
	}

	$project =& group_get_object($group_id);

	if (!$project || !is_object($project)) {
			return false;
	}

	$perm =& $project->getPermission( session_get_user() );
	if (!$perm || !is_object($perm) || !$perm->isMember()) {
		return false;
	}

	$type=strtoupper($type);
	
	switch ($type) {
		case 'P2' : {
			//pm admin
			return $perm->isPMAdmin();
			break; 
		}
		case 'F2' : {
			//forum admin
			return $perm->isForumAdmin();
			break; 
		}
		case '0' : {
			//just in this group
			return $perm->isMember();
			break;
		}
		case 'A' : {
			//admin for this group
			return $perm->isAdmin();
			break;
		}
		case 'D1' : {
			//document editor
			return $perm->isDocEditor();
			break;
		}
		default : {
			//fubar request
			return false;
		}
	}
	return false;
}

/**
 * user_getname() - DEPRECATED; DO NOT USE!
 *
 * @param		int		The User ID
 * @deprecated
 *
 */
function user_getname($user_id = false) {
	// use current user if one is not passed in
	if (!$user_id) {
		if (user_isloggedin()) {
			$user=&user_get_object(user_getid());
			if ($user) {
				return $user->getUnixName();
			} else {
				return 'Error getting user';
			}
		} else {
			return 'No User Id';
		}
	} else {
		$user=&user_get_object($user_id);
		if ($user) {
			return $user->getUnixName();
		} else {
			return 'Invalid User';
		}
	}
}

?>
