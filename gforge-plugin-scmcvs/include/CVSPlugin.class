<?php

require_once('common/include/User.class');

class CVSPlugin extends SCM {
	function CVSPlugin () {
		$this->SCM () ;
		$this->name = "scmcvs";
		$this->text = "CVS";
		$this->hooks[] = "scm_page";
		$this->hooks[] = "scm_admin_update";
		$this->hooks[] = "scm_admin_page";
		$this->hooks[] = "scm_stats";
		$this->hooks[] = "group_approved";
		//$this->hooks[] = "groupmenu_scm";

                require_once('/etc/gforge/plugins/scmcvs/config.php') ;
		
		$this->default_cvs_server = $default_cvs_server ;
		$this->this_server = $this_server ;
		$this->enabled_by_default = $enabled_by_default ;
		
		$this->register () ;
	}

	function CallHook ($hookname, $params) {
		global $Language, $HTML ;
		
		switch ($hookname) {
		case "scm_page":
			$group_id = $params['group_id'] ;
			$this->display_scm_page ($group_id) ;
			break ;
		case "scm_admin_update":
			$this->scm_admin_update ($params) ;
			break ;
		case "scm_admin_page":
			$this->display_scm_admin_page ($params) ;
			break ;
		case "scm_stats":
			$this->display_stats ($params) ;
			break;
		case "group_approved":
			$this->group_approved ($params) ;
			break;
		case "groupmenu_scm":
			$this->display_groupmenu_scm ($params) ;
			break;
		default:
			// Forgot something
		}
	}

	function display_scm_page ($group_id) {
		global $Language, $HTML ;

		$project =& group_get_object($group_id);
		
		if ($project->usesPlugin ("scmcvs")) {
			
		print $Language->getText('plugin_scmcvs','documentation');

		if($this->cvs_single_host) {
				$cvsrootend=$this->default_cvs_host.':/cvsroot/'.$project->getUnixName();
			} else {
				$cvsrootend='cvs.'.$project->getUnixName().'.'.$this->default_cvs_host.':/cvsroot/'.$project->getUnixName();
			}
// ######################## table for summary info

?>
<table width="100%">
	<tr valign="top">
		<td width="65%">
<?php
// ######################## anonymous CVS instructions

	//if ($this->UsesAnonCVS ($group_id)) {
	if ($project->enableAnonSCM()){
		echo $Language->getText('plugin_scmcvs', 'anoncvs');
		print " <p>
		                <tt>cvs -d :pserver:anonymous@" . $this->GetGroupServer($group_id) . ":/cvsroot/".$project->getUnixName()." login</tt><br>
		                <tt>cvs -d :pserver:anonymous@" . $this->GetGroupServer($group_id) . ":/cvsroot/".$project->getUnixName()." checkout <em>modulename</em></tt>
                        </p>" ;
	 }

// ############################ developer access
			
	echo $Language->getText('plugin_scmcvs', 'devcvs');
		print "<p>
                                <tt>export CVS_RSH=ssh</tt><br>
		                <tt>cvs -d :ext:<em>username</em>@" . $this->GetGroupServer($group_id) . ":/cvsroot/".$project->getUnixName()." checkout <em>modulename</em></tt>
                                </p>" ;

?>

		</td>
		<td width="35%">

<?php

// ############################## CVS Browsing

$anonymous = 1 ;
if (session_loggedin()) {
	$perm =& $project->getPermission(session_get_user());
	$anonymous = !$perm->isMember();
}
 
//if ($this->UsesAnonCVS ($group_id)) {
if ($project->enableAnonSCM()){
	echo $HTML->boxTop($Language->getText('plugin_scmcvs', 'history'));

	echo $Language->getText('plugin_scmcvs', 'browsetree');
	echo '<p><a href="'.$this->account_group_cvsweb_url($group_id).'">Browse CVS Tree</a></p>' ;
	echo $HTML->boxBottom();
}

?>
		</td>
	</tr>
</table>

<?php

// ************************************************



		}

	}

	function scm_admin_update ($params) {
		$group =& group_get_object($params['group_id']);
 		if ($params['scmcvs_enable_anoncvs']) {
			$group->SetUsesAnonSCM(true);
		} else {
			$group->SetUsesAnonSCM(false);
 		}
 		if ($params['scmcvs_enable_pserver']) {
			$group->SetUsesPserver(true);
		} else {
			$group->SetUsesPserver(false);
 		}
////		if ($params['scmradio'] == 'scmcvs') {
//// THIS IS NOT THE PLACE FOR THIS //////// TODO
			$group->setPluginUse("scmcvs", 1) ;
////			
////		} else {
////			$group->setPluginUse("scmcvs", 0) ;
////		}
// 		if ($params['scmcvs_use_cvs']) {
// 			$group->setPluginUse("scmcvs", 1) ;
// 		} else {
// 			$group->setPluginUse("scmcvs", 0) ;
// 		}
////		if ($params['scmcvs_enable_anon_cvs']) {
////			$this->SetUsesAnonCVS ($params['group_id'], true) ;
////		} else {
////			$this->SetUsesAnonCVS ($params['group_id'], false) ;
////		}
////		if ($params['scmcvs_cvs_server'] && $params['scmcvs_cvs_server'] != "") {
////			$this->SetGroupServer ($params['group_id'], $params['scmcvs_cvs_server']) ;
////		} else {
////			$this->SetGroupServer ($params['group_id'], $this->GetDefaultServer ()) ;
////		}
	}

	// This function is used to render checkboxes below
	function c($v) {
		if ($v) {
			return 'CHECKED';
		} else {
			return '';
		}
	}

	function todoornottodo() {
	?>
		<input type="radio" name="scmradio" value="scmcvs" <?php if ($group->usesPlugin("scmcvs")) {print '"checked"';} ?>> <strong>Use CVS</strong><br>
		<input type="checkbox" name="scmcvs_enable_anon_cvs" value="1" <?php if ($this->UsesAnonCVS($params['group_id'])) {print '"checked"';} ?>> <strong>Allow anonymous CVS</strong><br>
		<input type="text" name="scmcvs_cvs_server" value="<?php echo $this->GetGroupServer ($params['group_id']) ?>"> <strong>CVS server</strong><br><br>
	<?
	}

	function display_scm_admin_page ($params) {
		global $Language;
		$group =& group_get_object($params['group_id']);
	?>
		<input type="CHECKBOX" name="scmcvs_enable_anoncvs" value="1" <?php echo $this->c($group->enableAnonSCM()); ?> >
		<strong><?php echo $Language->getText('project_admin_editgroupinfo','enable_anonymous_cvs') ?></strong>
		<br />
		<input type="CHECKBOX" name="scmcvs_enable_pserver" value="1" <?php echo $this->c($group->enablePserver()); ?> >
		<strong><?php echo $Language->getText('project_admin_editgroupinfo','enable_pserver') ?></strong>
		<br />
	<?php
	}

	function display_stats ($params) {
		global $Language ;
		$group_id = $params['group_id'] ;
		$result = db_query("
			SELECT commits, adds
			FROM plugin_scmcvs_stats
			WHERE group_id='$group_id'");
		$commit_num = db_result($result,0,0);
		$add_num    = db_result($result,0,1);
		if (!$commit_num) {
			$commit_num=0;
		}
		if (!$add_num) {
			$add_num=0;
		}
		echo ' (CVS: '.$Language->getText('project_home','cvs_commits',array(number_format($commit_num,0),number_format($add_num,0))).")";
		if ($commit_num || $add_num) {
			echo '
		<br /> &nbsp; -
			<a href="'.$this->account_group_cvsweb_url($group_id).'">Browse CVS</a>';
	        }
		
	}
	/**
	 *      account_group_cvsweb_url() - Returns URL for group's CVS interface WWW
	 *
	 *	@param  string  The group name
	 *      @return URL to access CVS over HTTP
	 */
	function account_group_cvsweb_url($group_id) {
		$project =& group_get_object($group_id);
		if ( $GLOBALS['sys_scm_single_host'] == '1' ) {
			$scm_server = $GLOBALS['sys_scm_host'];
		} else {
			$scm_server = $this->GetGroupServer($group_id);
		}
		//return 'http://'.$scm_server.'/cgi-bin/cvsweb?cvsroot=cvsroot/'.$project->getUnixName();
		return 'http://'.$scm_server.'/plugins/scmcvs/cvsweb.php/?cvsroot=cvsroot/'.$project->getUnixName();
	}

	function display_groupmenu_scm($params) {
		$group_id = $params['group_id'] ;
		$project =& group_get_object($group_id);
		if (!$project || !is_object($project)) 
			return;
		if ($project->isError())
		        return;
		if (!$project->isProject())
		        return;
		if ( $project->usesPlugin ( $this->name ) ) {
	        	$params['DIRS'][]='/plugins/scmcvs/?group_id=' . $group_id;
			$params['TITLES'][]=$this->text;
			(($params['toptab'] == $this->name) ? $params['selected']=(count($params['TITLES'])-1) : '' );
		}
	}

	function group_approved ($params) {
		$group_id = $params['group_id'] ;
	
		$project =& group_get_object($group_id);

		if ($this->enabled_by_default) {
			$group->setPluginUse("scmcvs", 1) ;
		} else {
			$group->setPluginUse("scmcvs", 0) ;
		}
	}

	function GetDefaultServer () {
		return $this->default_cvs_server ;
	}

	function GetGroupServer ($group_id) {
		$sql = "SELECT cvs_host FROM plugin_scmcvs_group_usage WHERE group_id = $group_id" ;
		$res = db_query($sql);
		if (db_numrows($res) == 0) {
			return $this->default_cvs_server ;
		} else {
			return db_result($res,0,'cvs_host');
		}
	}

	function SetGroupServer ($group_id, $server) {
		db_begin () ;
		$sql = "SELECT cvs_host FROM plugin_scmcvs_group_usage WHERE group_id = $group_id" ;
		$res = db_query($sql);
		if (db_numrows($res) == 0) {
			$sql = "INSERT INTO plugin_scmcvs_group_usage (group_id, cvs_host) VALUES ($group_id, '$server')" ;
		} else {
			$sql = "UPDATE plugin_scmcvs_group_usage SET cvs_host = '$server' WHERE group_id = $group_id" ;
			
		}
		$res = db_query($sql);
		db_commit () ;
	}

	function UsesAnonCVS ($group_id) {
		$sql = "SELECT anon_cvs FROM plugin_scmcvs_group_usage WHERE group_id = $group_id" ;
		$res = db_query($sql);
		if (db_numrows($res) == 0) {
			return false ;
		} else {
			return db_result($res,0,'anon_cvs');
		}
	}

	function SetUsesAnonCVS ($group_id, $anon_cvs) {
		db_begin () ;
		$anon_cvs = $anon_cvs ? 1 : 0 ;

		$sql = "SELECT anon_cvs FROM plugin_scmcvs_group_usage WHERE group_id = $group_id" ;
		$res = db_query($sql);
		if (db_numrows($res) == 0) {
			$sql = "INSERT INTO plugin_scmcvs_group_usage (group_id, anon_cvs) VALUES ($group_id, $anon_cvs)" ;
		} else {
			$sql = "UPDATE plugin_scmcvs_group_usage SET anon_cvs = $anon_cvs WHERE group_id = $group_id" ;
			
		}
		$res = db_query($sql);
		db_commit () ;
	}

}

// Local Variables:
// mode: php
// c-file-style: "bsd"
// End:

?>
