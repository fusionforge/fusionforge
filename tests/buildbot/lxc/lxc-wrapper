#! /bin/sh

set -e

cmd=$1
case "$cmd" in
    start|stop|upgrade|destroy|refresh|prepare|emptycache)
	echo "Handling command $cmd"
	;;
    *)
	echo "Unknown command"
	exit 1
	;;
esac

host=$2
case "$host" in
    centos5|centos6|centos7|debian7|debian8)
	echo "Handling host $host"
	;;
    *)
	echo "Unknown host"
	exit 1
	;;
esac

sed -i -e "s/lxc.cap.drop = mac_admin mac_override.*/lxc.cap.drop = mac_admin mac_override/" /usr/share/lxc/config/centos.common.conf
sed -i -e "s/^ *chroot \$rootfs_path passwd -e root/# DISABLED # &/" /usr/share/lxc/templates/lxc-centos

# Get variables
case $host in
    centos*)
	template=centos
	release=${host#centos}
	cachedir=/var/cache/lxc/centos/x86_64/$release/rootfs
	;;
    debian*)
	template=debian
	case $host in
	    debian7)
		release=wheezy
		;;
	    debian8)
		release=jessie
		;;
	esac
	cachedir=/var/cache/lxc/debian/rootfs-$release-amd64
	export MIRROR=http://ftp.fr.debian.org/debian
	;;
esac
rootfs=/var/lib/lxc/$host.local/rootfs

case $cmd in
    destroy)
	$0 stop $host
	if lxc-ls --stopped | grep -q $host.local ; then
	    lxc-destroy -n $host.local
	fi
	;;
    
    emptycache)
	$0 destroy $host
	rm -rf $cachedir
	;;

    prepare)
	if [ ! -e $cachedir ] ; then
	    lxc-create -t $template -f /etc/lxc/default.conf --name $host.local -- --release $release
	    lxc-destroy -n $host.local || true
	    
	    case $host in
		centos7)
		    chroot $cachedir usermod --expiredate $(date +"%Y-%m-%d" -d "1 year") root
		    chroot $cachedir yum install -y avahi-autoipd avahi-daemon nscd cronie
		    sed -i -e s/^PIDFile/#PIDFile/ $cachedir/lib/systemd/system/nscd.service 
		    cat >> $cachedir/usr/local/sbin/update-hosts <<EOF
#! /bin/sh
sleep 5
(echo -n \$(/sbin/ip addr show dev eth0 | awk '/inet / { print \$2 }'|cut -d/ -f1) ; echo -n " " ; echo $host.local $host) >> /etc/hosts 2> /root/log
EOF
		    mkdir -p $cachedir/etc/cron.d
		    echo '@reboot root sh /usr/local/sbin/update-hosts' > $cachedir/etc/cron.d/boot-update-hosts
		    ;;
		centos5)
		    chroot $cachedir yum install -y avahi vixie-cron
		    cat >> $cachedir/usr/local/sbin/update-hosts <<EOF
#! /bin/sh
sleep 5
(echo -n \$(/sbin/ip addr show dev eth0 | awk '/inet / { print \$2 }'|cut -d/ -f1) ; echo -n " " ; echo $host.local $host) >> /etc/hosts 2> /root/log
EOF
		    mkdir -p $cachedir/etc/cron.d
		    echo '@reboot root sh /usr/local/sbin/update-hosts' > $cachedir/etc/cron.d/boot-update-hosts
		    ;;
		centos6)
		    chroot $cachedir yum install -y avahi-autoipd avahi cronie
		    cat >> $cachedir/usr/local/sbin/update-hosts <<EOF
#! /bin/sh
sleep 5
(echo -n \$(/sbin/ip addr show dev eth0 | awk '/inet / { print \$2 }'|cut -d/ -f1) ; echo -n " " ; echo $host.local $host) >> /etc/hosts 2> /root/log
EOF
		    mkdir -p $cachedir/etc/cron.d
		    echo '@reboot root sh /usr/local/sbin/update-hosts' > $cachedir/etc/cron.d/boot-update-hosts
		    ;;
		debian*)
		    chroot $cachedir apt-get install --yes avahi-autoipd avahi-daemon unattended-upgrades bash-completion
		    # Avoid "Invalid Email Address" during CreateForum::testEmailAddressNotAlreadyUsed
		    cat <<EOF >> $cachedir/etc/hosts
127.0.1.1	$host.local
EOF
		    ;;
	    esac
	    sed -i -e /^rlimit-nproc=/d $cachedir/etc/avahi/avahi-daemon.conf
	    
	    mkdir -p $cachedir/root/.ssh
	    cp /var/lib/jenkins/.ssh/id_rsa.pub $cachedir/root/.ssh/authorized_keys

	    # SSH host key cache
	    # TODO: populate it if it doesn't exist yet
	    cp /var/cache/lxc/ssh/$host.local/* $cachedir/etc/ssh
	fi

	$0 upgrade $host
	;;

    refresh)
	if [ ! -d $cachedir ] ; then
	    $0 prepare $host
	fi
	$0 destroy $host
	lxc-create -t $template -f /etc/lxc/default.conf --name $host.local -- --release $release
	case $host in
	    centos*)
		echo "127.0.0.1 localhost" > $rootfs/etc/hosts
		echo "$host.local" > $rootfs/etc/hostname
		;;
	esac
	;;
    
    upgrade)
	$0 destroy $host
	case $host in
	    centos*)
		mount --bind /proc $cachedir/proc
		chroot $cachedir sh -c "yum update -y"
		umount $cachedir/proc
		;;
	    debian*)
		mount --bind /proc $cachedir/proc
		chroot $cachedir sh -c "apt-get update"
		chroot $cachedir sh -c "unattended-upgrades -d"
		chroot $cachedir sh -c "apt-get clean"
		umount $cachedir/proc
		
		find $cachedir/var/log/unattended-upgrades -type f -mtime +30 | xargs -r rm
		;;
	esac
	;;

    start)
	if [ ! -d $rootfs ] ; then
	    $0 refresh $host
	fi
	case $host in
	    debian*)
		cp /var/cache/lxc/ssh/$host.local/* $rootfs/etc/ssh
		;;
	esac
	hwaddr=00:16:3e:$(echo $host | md5sum | cut -c -6 | sed s/../\&:/g | sed s/:$//)
	lxc-start --name $host.local -s lxc.network.hwaddr=$hwaddr -s lxc.utsname=$host --daemon
	;;

    stop)
	if lxc-ls --active | grep -q $host.local ; then
	    lxc-stop --name $host.local --kill
	fi
	;;
esac
